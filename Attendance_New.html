<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Attendance</title>

<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="attendance_new.css">
<script src="config.js"></script> <!-- Âê´ API_URL Âíå showNotification() -->
</head>
<body class="v2">

<!-- ========== Container 1: ÈÄâÊã©ËØæÁ®ã ========== -->
<div class="container" id="selectClassContainer">
  <h2>Select Class</h2>
  <div id="classList" class="class-list"></div>
  <button id="loadAttendanceBtn" class="btn-primary" disabled>Load Attendance</button>
</div>

<!-- ========== Container 2: Â≠¶ÁîüËÄÉÂã§Âå∫ ========== -->
<div class="container" id="attendanceContainer" style="display:none;">
  <div class="class-info" id="classInfo"></div>
  <div class="stats" id="summaryBar">Total: 0 | üü¢ P: 0 | üî¥ A: 0 | üü° L: 0</div>

  <div class="btn-group">
    <button class="attendance-btn present active" id="presentBtn">Present</button>
    <button class="attendance-btn absent" id="absentBtn">Absent</button>
    <button class="attendance-btn leave" id="leaveBtn">Leave</button>
  </div>

  <div class="divider"></div>

  <div class="student-grid" id="studentGrid"></div>

  <div style="text-align:center;margin-top:24px;">
    <button id="submitBtn" class="btn-primary">Submit Attendance</button>
  </div>
</div>

<script>
/* =====================================================
   ÂÖ®Â±ÄÂèòÈáè
===================================================== */
let selectedClass = null;
let currentStatus = "present";
const attendanceMap = new Map();  // studentId ‚Üí { studentName, gender, status, notes }

/* =====================================================
   È°µÈù¢Âä†ËΩΩÂêéÊãâÂèñËØæÁ®ã
===================================================== */
document.addEventListener("DOMContentLoaded", loadActiveClasses);

async function loadActiveClasses() {
  try {
    const res = await fetch(API_URL + "?action=getActiveClasses");
    const json = await res.json();
    if (!json.ok) throw new Error(json.message || "Failed to load classes");

    renderClassList(json.data);
  } catch (err) {
    showNotification("‚ö†Ô∏è " + err.message, "error");
  }
}

/* =====================================================
   Ê∏≤ÊüìËØæÁ®ãÂàóË°®
===================================================== */
function renderClassList(classes) {
  const container = document.getElementById("classList");
  container.innerHTML = "";

  classes.forEach(cls => {
    const div = document.createElement("div");
    div.className = "class-item";
    div.textContent = `${cls.className} (${cls.dayOfWeek})`;
    div.addEventListener("click", () => onSelectClass(div, cls.className));
    container.appendChild(div);
  });
}

/* =====================================================
   ÈÄâ‰∏≠ËØæÁ®ã
===================================================== */
function onSelectClass(div, className) {
  document.querySelectorAll(".class-item").forEach(el => el.classList.remove("active"));
  div.classList.add("active");
  selectedClass = className;
  document.getElementById("loadAttendanceBtn").disabled = false;
}

/* =====================================================
   Âä†ËΩΩÂ≠¶ÁîüÂàóË°®
===================================================== */
document.getElementById("loadAttendanceBtn").addEventListener("click", async () => {
  if (!selectedClass) return;

  try {
    const res = await fetch(API_URL + "?action=getStudentsByClass&className=" + encodeURIComponent(selectedClass));
    const json = await res.json();
    if (!json.ok) throw new Error(json.message || "Failed to load students");

    document.getElementById("selectClassContainer").style.display = "none";
    document.getElementById("attendanceContainer").style.display = "block";
    document.getElementById("classInfo").textContent = selectedClass;

    renderStudents(json.data);
    showNotification("‚úÖ Students loaded for " + selectedClass);
  } catch (err) {
    showNotification("‚ö†Ô∏è " + err.message, "error");
  }
});

/* =====================================================
   Ê∏≤ÊüìÂ≠¶ÁîüÂç°Áâá
===================================================== */
function renderStudents(students) {
  const grid = document.getElementById("studentGrid");
  grid.innerHTML = "";
  attendanceMap.clear();

  students.forEach(stu => {
    const card = document.createElement("div");
    card.className = "student-card";
    card.dataset.id = stu.studentId;

    const defaultState = stu.leaveNote ? "leave" : "present";
    attendanceMap.set(stu.studentId, {
      studentName: stu.studentName,
      gender: stu.gender,
      status: defaultState,
      notes: stu.leaveNote || ""
    });
    card.classList.add(defaultState);

    // ÂΩ©Êù°
    const bar = document.createElement("div");
    bar.className = "status-bar";
    card.appendChild(bar);

    // ÂßìÂêç + ÊÄßÂà´
    const nameDiv = document.createElement("div");
    nameDiv.className = "student-name";
    nameDiv.textContent = stu.studentName + " ";
    const genderIcon = document.createElement("img");
    genderIcon.src = stu.gender === "male" ? "icons/male.svg" : "icons/female.svg";
    genderIcon.width = 18;
    genderIcon.height = 18;
    nameDiv.appendChild(genderIcon);
    card.appendChild(nameDiv);

    // Notes
    const noteDiv = document.createElement("div");
    noteDiv.className = "student-note";
    noteDiv.textContent = stu.leaveNote ? "üìù " + stu.leaveNote : "";
    card.appendChild(noteDiv);

    card.addEventListener("click", () => onStudentClick(card, stu.studentId, noteDiv));
    grid.appendChild(card);
  });

  updateSummary();
}

/* =====================================================
   ÂàáÊç¢Áä∂ÊÄÅÊåâÈíÆ
===================================================== */
document.getElementById("presentBtn").addEventListener("click", () => setStatus("present"));
document.getElementById("absentBtn").addEventListener("click", () => setStatus("absent"));
document.getElementById("leaveBtn").addEventListener("click", () => setStatus("leave"));

function setStatus(mode) {
  currentStatus = mode;
  document.querySelectorAll(".attendance-btn").forEach(btn => btn.classList.remove("active"));
  document.querySelector(`.attendance-btn.${mode}`).classList.add("active");
}

/* =====================================================
   Â≠¶ÁîüÁÇπÂáªÂç°Áâá
===================================================== */
function onStudentClick(card, studentId, noteDiv) {
  const record = attendanceMap.get(studentId);
  record.status = currentStatus;
  card.classList.remove("present", "absent", "leave");
  card.classList.add(currentStatus);

  if (currentStatus === "leave") {
    let note = record.notes || "";
    note = prompt("Enter leave note:", note) || note;
    record.notes = note;
    noteDiv.textContent = note ? "üìù " + note : "";
  } else {
    record.notes = "";
    noteDiv.textContent = "";
  }

  attendanceMap.set(studentId, record);
  updateSummary();
}

/* =====================================================
   Êõ¥Êñ∞ÁªüËÆ°Ê†è
===================================================== */
function updateSummary() {
  const total = attendanceMap.size;
  let p = 0, a = 0, l = 0;
  attendanceMap.forEach(rec => {
    if (rec.status === "present") p++;
    if (rec.status === "absent") a++;
    if (rec.status === "leave") l++;
  });
  document.getElementById("summaryBar").textContent =
    `Total: ${total} | üü¢ P: ${p} | üî¥ A: ${a} | üü° L: ${l}`;
}

/* =====================================================
   Êèê‰∫§ÊâìÂç° (records.pushÁªìÊûÑ)
===================================================== */
document.getElementById("submitBtn").addEventListener("click", submitAttendance);

async function submitAttendance() {
  if (!selectedClass) {
    showNotification("‚ö†Ô∏è Please select a class first", "error");
    return;
  }

  const records = [];
  attendanceMap.forEach((rec, studentId) => {
    records.push({
      studentId,
      studentName: rec.studentName,
      gender: rec.gender,
      status: rec.status,
      notes: rec.notes
    });
  });

  try {
    const body = new URLSearchParams({
      action: "submitAttendance",
      className: selectedClass,
      date: new Date().toISOString().split("T")[0],
      records: JSON.stringify(records)
    });

    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
      body
    });

    const json = await res.json();
    if (!json.ok) throw new Error(json.message || "Submit failed");
    showNotification("‚úÖ " + json.message);
  } catch (err) {
    showNotification("‚ö†Ô∏è " + err.message, "error");
  }
}
</script>
</body>
</html>
