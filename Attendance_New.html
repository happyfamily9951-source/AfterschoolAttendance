<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
    <title>Attendance</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="attendance_new.css">    <!-- API_URL and showNotification() -->
    <script src="config.js"></script>    
  </head>
  
  <body class="page-attendance">
    <img src="icons/logo-monica-linan.svg" alt="Logo" class="logo-top-left">
   
    <main class="page-content">

      <!-- Select class -->
      <div class="form-container" id="selectClassContainer">
        <h2>Select Class</h2>
        <!-- Notification bar -->
        <div id="notification" class="notification hidden"></div>
        
        <select id="classSelect" class="class-list"></select>
        <button class="btn-primary" id="loadAttendanceBtn" disabled>Get Student List</button>
      </div>

      <!-- Student attendance -->
      <div class="form-container" id="attendanceContainer" style="display:none;">
        <h2>Mark Attendance</h2>
        <!-- Notification bar -->
        <div id="notification" class="notification hidden"></div>   
        <div id="classInfo"></div>
        <br>
        <div class="stats" id="summaryBar">Total: 0 | üü¢ P: 0 | üî¥ A: 0 | üü° L: 0</div> 
        <br>
        
        <div class="btn-group">
          <button class="attendance-btn present active" id="presentBtn">Present</button>
          <button class="attendance-btn absent" id="absentBtn">Absent</button>
          <button class="attendance-btn leave" id="leaveBtn">Leave</button>
        </div>
        
        <!-- ÂàÜÈöîÁ∫ø -->
        <div class="divider"></div>
        <div class="student-grid" id="studentGrid"></div>

        <div style="text-align:center;margin-top:24px;">
          <button id="submitBtn" class="btn-primary">Submit Attendance</button>
        </div>
        
      </div>
    </main>
    
    <!-- Nagivator button on the bottom -->
    <nav class="bottom-nav">
      <a class="nav-item nav-student active" href="StudentEnrollment.html" aria-label="Student Enrollment">
        <img src="icons/student-enroll.svg" alt="">
      </a>
      <a class="nav-item nav-course" href="CourseEnrollment.html" aria-label="Course Enrollment">
        <img src="icons/course-enroll.svg" alt="">
      </a>
      <a class="nav-item nav-student-course-application" href="StudentCourseApplication.html" aria-label="Student Course Application">
        <img src="icons/student-course-application.svg" alt="">
      </a>    
      <a class="nav-item nav-attend" href="Attendance.html" aria-label="Attendance">
        <img src="icons/attendance.svg" alt="">
      </a>
      <a class="nav-item nav-report" href="Report.html" aria-label="Reports">
        <img src="icons/report.svg" alt="">
      </a>
    </nav>
    
    <script>
      let selectedClass = null;
      let currentClassName = null;
      let currentStatus = "present";
      const attendanceMap = new Map();  // studentId -> {studentNam, gender, status, notes}

      /* ========================================
          Initialization after loading HTML page
      ==========================================*/
      
      document.addEventListener("DOMContentLoaded", () => {

        console.log("‚úÖ DOM fully loaded.");
        
        // Initialization
        loadActiveClasses();
        document.getElementById("loadAttendanceBtn").addEventListener("click", getStudents); 
        document.getElementById("submitBtn").addEventListener("click", submitAttendance);
        document.getElementById("presentBtn").addEventListener("click", () => setStatus("present"));
        document.getElementById("absentBtn").addEventListener("click", () => setStatus("absent"));
        document.getElementById("leaveBtn").addEventListener("click", () => setStatus("leave"));
      });
        

      // 1. Load active classes list      
      async function loadActiveClasses() {

        console.log("üìò loadActiveClasses() triggered");
        try {                    
          const response = await fetch(`${API_URL}?action=getActiveClasses`);
          const result = await response.json();
          console.log("üìò API response:", result.results);

          if(!result.ok) throw new Error(response.message || "Failed to load classes");
          renderClassList(result.results);
        } catch (err) {
          console.error("‚ùå loadActiveClasses error:", err);
          showNotification("‚ö†Ô∏è Loading class failure: " + err.message, "error");
        }
      }

      function renderClassList(classes) {
        console.log("üìó renderClassList() received:", classes);
        const select = document.getElementById("classSelect");
        console.log("üìó classList container:", select);
        select.innerHTML = "";

        // Default option
        const defaultOption = document.createElement("option");
        defaultOption.value = "";
        defaultOption.textContent = "-- Select a class --";
        select.appendChild(defaultOption);
        
        classes.forEach(cls => {
          const option = document.createElement("option");
          option.value = cls.className;
          option.textContent = `${cls.className} (${cls.dayOfWeek})${cls.highlight?" üü¢ Today" : ""}`;
          console.log("Classname: ", cls.className, ", dayOfWeek: ", cls.dayOfWeek, ", highlight: ", cls.highlight);
          select.appendChild(option);          
        });

        select.disabled = false;

        // 
        select.addEventListener("change", e=> {
          const selectedValue = e.target.value;
          if (!selectedValue) {
            selectedClass = null;
            document.getElementById("loadAttendanceBtn").disabled = true;
            return;
          }

          selectedClass = selectedValue;
          const selectedObj = classes.find(c=> c.className === selectedValue);
          const today = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"] [new Date().getDay()];

          if (selectedObj && selectedObj.dayOfWeek !== today) {
            const proceed = confirm(`This selected class is not today (${today}). Continue?`);
            if (!process) {
              showNotification("‚ùå Cancelled loading attendance.", "error");
              selectedClass = null;
              e.target.value = "";
              document.getElementById("loadAttendanceBtn").disabled = true;
              return;
            }
          }

          document.getElementById("loadAttendanceBtn").disabled = false;
        });
      }

      // 2. Choose a class and get student list
      async function getStudents() {

        console.log("Get students...");
        if (!currentClassName) {
          showNotification("‚ö†Ô∏è Please select a class first", "error");
          return;
        }

        // Retrieve the selected class title
        const cls = Array.from(document.querySelectorAll(".class-item"))
          .find(el => el.classList.contains("active"));
        
        // Extract dayOfWeek: className format is "class name (Tue)"Ôºâ        
        const match = cls?.textContent.match(/\((\w+)\)$/);
        const dayOfWeek = match ? match[1] : "";
        const todayName = new Date().toLocaleString("en-us", {weekday: "short"});  // weekday: "long" ==> Monday        

        if (dayOfWeek && dayOfWeek !== todayName) {
          const proceed = confirm(`The selected class is not today (${todayName}). Continue?`);

          if (!proceed) {
            showNotification("‚ùå Cancelled loading attendance.", "error");
          }
        }
         console.log("Start get students by class: ",currentClassName, ", dayOfWeek: ", dayOfWeek);

        try {
          const response = await fetch(`${API_URL}?action=getStudentsByClass&className=${encodeURIComponent(currentClassName)}`);
          const result = await response.json();
          
          if (result.ok) {
            // document.getElementById("selectClassContainer").style.display = "none";
            document.getElementById("attendanceContainer").style.display = "block";
            document.getElementById("classInfo").textContent = currentClassName;

            renderStudents(result.results);
            showNotification("‚úÖ Students loaded for " + currentClassName);
          }
        } catch (err) {
          showNotification("‚ö†Ô∏è " + err.message, "error");
        }
      }

      // render student cards
      function renderStudents(students) {
        
        const grid = document.getElementById("studentGrid");        
        grid.innerHTML = "";
        attendanceMap.clear();
        
        students.forEach(s => {
          const card = document.createElement("div");
          card.className = "student-card";
          const state = s.leaveNote ?"leave":"present";
          attendanceMap.set(s.studentId, {
            studentName: s.studentName,
            gender: s.gender,
            status: state,
            notes: s.leaveNote || ""
          });
          card.classList.add(state);

          // Top bar
          const bar = document.createElement("div")
          bar.className = "status-bar";
          card.appendChild(bar);

          // Gender
          const genderIcon = document.createElement("img");
          genderIcon.className = "gender-icon";
          genderIcon.src = s.gender === "M"?"icons/male.svg" : "icons/female.svg";
          card.appendChild(genderIcon);

          // Student Name
          const nameDiv = document.createElement("div");
          nameDiv.className = "student-name";
          nameDiv.textContent = s.studentName;          
          card.appendChild(nameDiv);

          console.log("Student name: ",s.studentName);

          // Notes
          const noteDiv = document.createElement("div");
          noteDiv.className = "student-note";
          noteDiv.textContent = s.leaveNote ?"üìù " + s.leaveNote : "";
          card.appendChild(noteDiv);

          // Click Button
          card.addEventListener("click", () => onStudentClick(card, s.studentId, noteDiv));
          grid.appendChild(card);
        });

        console.log("Update summary");
        updateSummary();
      }
      
      /* ===============================
      ÂàáÊç¢Áä∂ÊÄÅÊåâÈíÆ
      =================================*/
      document.getElementById("presentBtn").addEventListener("click", () => setStatus("present"));
      document.getElementById("absentBtn").addEventListener("click", () => setStatus("absent"));
      document.getElementById("leaveBtn").addEventListener("click", () => setStatus("leave"));
      
      function setStatus(mode) {
        currentStatus = mode;
        document.querySelectorAll(".attendance-btn").forEach(btn => btn.classList.remove("active"));
        document.querySelector(`.attendance-btn.${mode}`).classList.add("active");
      }
      
      /* ===============================
      Â≠¶ÁîüÁÇπÂáªÊâìÂç°
      =================================*/
      function onStudentClick(card, studentId, noteDiv) {

        const record = attendanceMap.get(studentId);

        // update summary even if status unchanged
        if (record.status === currentStatus) {
          udpateSummary();
          return;
        }

        record.status = currentStatus;
        card.classList.remove("present", "absent", "leave");
        card.classList.add(currentStatus);
        
        if (currentStatus === "leave") {
          let note = noteDiv.textContent.replace("üìù ", "") || "";
          note = prompt("Enter leave note:", note) || note;
          noteDiv.textContent = note ? "üìù " + note : "";
        } else {
          record.notes = "";
          noteDiv.textContent = "";
        }

        attendanceMap.set(studentId, record);
        updateSummary();
      }
      
      /* ===============================
      Êõ¥Êñ∞ÁªüËÆ°Ê†è
      =================================*/
      function updateSummary() {
        const total = attendanceMap.size;
        let p = 0, a = 0, l = 0;
        attendanceMap.forEach(v => {
          if (v.status === "present") p++;
          if (v.status === "absent") a++;
          if (v.status === "leave") l++;
        });
        document.getElementById("summaryBar").textContent = `Total: ${total} | üü¢ P: ${p} | üî¥ A: ${a} | üü° L: ${l}`;
      }      

      // Submit attendace
      async function submitAttendance() {
        const btn = document.getElementById("submitBtn");
        btn.disabled = true;
        const originalText = btn.innerText;
        btn.innerText = "Submitting...";

        const records = [];
        attendanceMap.forEach((rec, studentId) => {
          records.push({
            studentId, 
            studentName: rec.studentName,
            gender: rec.gender,
            status: rec.status,
            notes: rec.notes
          });
        });

        if (records.length == 0) {
          showNotification("‚ö†Ô∏è No records to submit.", "error");
          return;
        }

        // Version A: Convert to x-www-form-urlencoded format
        const body = 
          "action=" + encodeURIComponent("markAttendance") +
          "&className=" + encodeURIComponent(currentClassName) +
          "&records=" + encodeURIComponent(JSON.stringify(records)); 

        // Version B: JSON
        // const payload = {
        // action: "markAttendance",
        // className: currentClassName,
        // records: records
        // };

        try {          

          // Version A: x-www-form-urlencoded format
          const response = await fetch(API_URL, {
            method: "POST",
            headers: {"Content-Type": "application/x-www-form-urlencoded;charset=UTF-8"},            
            body: body
          });

          // Version B: JSON
          // const response = await fetch(API_URL, {
          //  method: "POST",
          //  headers: {"Content-Type": "application/json"},
          //  body: JSON.stringify(payload)
          //});

          const result = await response.json();
          if (result.ok) {
            showNotification(`‚úÖ Attendance submitted! (${result.count} records)`, "success");                        
          } else {
            showNotification(`‚ùå Error: ${result.message || "Unknown error"}`, "error");            
          }
        } catch (err) {
          showNotification("‚ùå Network error: " + err.message, "error");          
        } finally {
          btn.disabled = false;
          btn.innerText = originalText;
        }
      }
    </script>
  </body>
</html>
