

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è€ƒå‹¤ç³»ç»Ÿ Attendance</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 10px; }
    h2 { color: #002060; }
    button {
      margin: 3px;
      padding: 6px 12px;
      font-size: 14px;
      border-radius: 6px;
      cursor: pointer;
    }

    table { border-collapse: collapse; width: 100%; margin-top: 15px; }
    th, td { border: 1px solid #ddd; padding: 6px; text-align: center; }
    th { background-color: #f2f2f2; }
    
    .present { background-color: #28a745; color: white; }
    .leave { background-color: #ff9800; color: white; }
    .absent { background-color: #dc3545; color: white; }
    .disabled { background-color: #ccc; color: #666; pointer-events: none; }
    .reset { background-color: #6c757d; color: white; }

    #stats { margin-top: 15px; font-weight: bold; color: #002060; }

    #submitArea { margin-top: 20px; }
  </style>
</head>

<body>
  <h2> ç­çº§è€ƒå‹¤ / Class Attendance </h2>

  <!-- === Select Class Area === -->
  <div id="classSelection">
    <p>é€‰æ‹©ç­çº§ / Select Class</p2>
    <div id="classButtons">Loading...</div>
    <button onclick="resetClassSelection()" class="reset">é‡ç½®ç­çº§ / Reset Class</button>
  </div>

  <!-- === ç»Ÿè®¡æ  Statistics === -->
  <p id="stats">
    Class: - | Student / Guardian (å…± 0 äºº) | Present: 0 | Leave: 0 | Absent: 0
  </p>
  
  <!-- === Student Attendance Table Area === -->
  <table id="attendanceTable">
    <thead>
      <tr>
        <th>Student / Guardian</th>
        <th>Present</th>
        <th>Leave</th>
        <th>Absent</th>
        <th>Notes</th>
        <th>Reset</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- æäº¤åŒºåŸŸ -->
  <div id="submitArea">
    <button onclick="previewSubmission()">é¢„è§ˆæäº¤ / Preview Submission</button>
    <button id="submitBtn" onclick="submitAll()">æäº¤å…¨ç­æ‰“å¡ / Submit All</button>
  </div>

  <!-- === Public configuration file === -->
  <script src="config.js"></script>
  
  <script>
    // const API_URL = "https://script.google.com/macros/s/AKfycbywt8Y5aqs-NwVU1L-FT_zB4BZXal7Kq3OfwHFkeAp5HyLS8XFit1DIj7F1oifusdBJ/exec";

    // === Google Sheet Name Central Management ===
    const SHEET_NAME ={
      students: "Students",
      classes: "Classes",
      attendance: "Attendance",
      studentClassDetails: "Student-Class-Details",
      leave: "LeaveRequests",
      report: "Report"
    };

    let currentClass = null;
    let studentData = [];
    let stats = { present: 0, leave: 0, absent: 0 };


    // åŠ è½½ç­çº§æŒ‰é’®
    async function loadClasses() {
      const res = await fetch(`${API_URL}?action=getClasses`);
      const json = await res.json();
      const container = document.getElementById("classButtons");
      container.innerHTML = "";

      // Retrieve the day of today
      const todayIdx = new Date().getDay();
      const weekMap = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
      const todayStr = weekMap[todayIdx];

      json.classes.forEach(cls => {
        const btn = document.createElement("button");
        btn.textContent = cls;

        // If className includes weekDay, highligh
        if (cls.includes(todayStr)) {
          btn.style.backgroundColor = "#007BFF"; // Blue
          btn.style.color = "white";
        }
        
        btn.onclick = () => selectClass(cls, btn);
        container.appendChild(btn);
      });

      //const resetBtn = document.createElement("button");
      //resetBtn.textContent = "é‡ç½®ç­çº§ / Reset Class";
      //resetBtn.classList.add("reset");
      //resetBtn.onclick = resetClassSelection;
      //container.appendChild(resetBtn);
    }


    // é€‰æ‹©ç­çº§
    async function selectClass(cls, clickedBtn) {
      currentClass = cls;
      stats = { present: 0, leave: 0, absent: 0 };
      
      document.querySelectorAll("#classButtons button").forEach(b => {
        if (b !== clickedBtn && b.textContent !== "Reset") {
          b.disabled = true;
          b.classList.add("disabled");
        } else if (b === clickedBtn) {
          b.classList.add("present");
        }
      });

      try {
        const res = await fetch(`${API_URL}?action=getStudents&className=${encodeURIComponent(cls)}`);
        const json = await res.json();
        students = json.students;
        renderTable(students);
        updateStats();
      } catch (err) {
        console.error("åŠ è½½å­¦ç”Ÿå¤±è´¥:", err);
        document.getElementById("stats").textContent = "åŠ è½½å­¦ç”Ÿå¤±è´¥: " + err.message;
      }
    }

    // æ¸²æŸ“å­¦ç”Ÿè¡¨æ ¼
    function renderTable(students) {
      const tbody = document.getElementById("attendanceTable").querySelector("tbody");
      tbody.innerHTML = "";

      students.forEach((stu, i) => {
        const tr = document.createElement("tr");
        const tdName = document.createElement("td");

        tdName.innerHTML = `
          ${stu.studentName} / ${stu.guardianName} (${stu.guardianPhone})
          <a href="tel:${stu.guardianPhone}" style="margin-left:8px; text-decoration:none;">ğŸ“</a>
          <a href="sms:${stu.guardianPhone}" style="margin-left:5px; text-decoration:none;">ğŸ’¬</a>
          `;
        tr.appendChild(tdName);

        const tdPresent = document.createElement("td");
        const btnPresent = document.createElement("button");
        btnPresent.textContent = "Present";
        btnPresent.className = "present";
        btnPresent.onclick = () => markAttendance(i, "present", btnPresent);
        tdPresent.appendChild(btnPresent);
        tr.appendChild(tdPresent);

        const tdLeave = document.createElement("td");
        const btnLeave = document.createElement("button");
        btnLeave.textContent = "Leave";
        btnLeave.className = "leave";
        btnLeave.onclick = () => markAttendance(i, "leave", btnLeave);
        tdLeave.appendChild(btnLeave);
        tr.appendChild(tdLeave);

        const tdAbsent = document.createElement("td");
        const btnAbsent = document.createElement("button");
        btnAbsent.textContent = "Absent";
        btnAbsent.className = "absent";
        btnAbsent.onclick = () => markAttendance(i, "absent", btnAbsent);
        tdAbsent.appendChild(btnAbsent);
        tr.appendChild(tdAbsent);

        const tdNotes = document.createElement("td");
        const noteInput = document.createElement("input");
        noteInput.type = "text";
        noteInput.id = `note-${i}`;
        noteInput.value = stu.notes || ""; 
        tdNotes.appendChild(noteInput);
        tr.appendChild(tdNotes);

        const tdReset = document.createElement("td");
        const btnReset = document.createElement("button");
        btnReset.textContent = "Reset";
        btnReset.className = "reset";
        btnReset.onclick = () => resetRow(i, tr);
        tdReset.appendChild(btnReset);
        tr.appendChild(tdReset);

        // Highlight button based on stu.status
        if (stu.status) {
          let activeBtn = null;
          if (stu.status === "present") activeBtn = btnPresent;
          if (stu.status === "leave") activeBtn = btnLeave;
          if (stu.status === "absent") activeBtn = btnAbsent;

          if (activeBtn) {
            activeBtn.disabled = true; // 
            [btnPresent, btnLeave, btnAbsent].forEach( b=> {
              if (b!= activeBtn) {
                b.disabled = true;
                b.classList.add("disabled");
              }
            });
          }
        }
        
        tbody.appendChild(tr);
      });
    }

    // ç‚¹å‡»çŠ¶æ€æŒ‰é’®
    function markAttendance(index, type, clickedBtn) {

      const row = clickedBtn.closest("tr");
      //const row = clickedBtn.parentNode.parentNode;
      const buttons = row.querySelectorAll("button");

      buttons.forEach(b => {
        if (!b.classList.contains("reset")) {
          if (b === clickedBtn) {
            b.disabled = true;  // Current visiable, but disabled
            b.classList.remove("disabled");
          } else {
            b.disabled = false;
            b.classList.add("disabled");
        }
        }
      });

      // clickedBtn.disabled = true;
      students[index].status = type;
      updateStats();
    }

    // Reset å•è¡Œ
    function resetRow(index, row) {
      const buttons = row.querySelectorAll("button");
      buttons.forEach(b => {
        if (!b.classList.contains("reset")) {
          b.disabled = false;
          b.classList.remove("disabled");
        }
      });

      students[index].status = null;
      updateStats();
    }

    // æ›´æ–°ç»Ÿè®¡
    function updateStats() {
      stats = { present: 0, leave: 0, absent: 0 };
      students.forEach(stu => {
        if (stu.status === "present") stats.present++;
        if (stu.status === "leave") stats.leave++;
        if (stu.status === "absent") stats.absent++;
      });
      
      document.getElementById("stats").textContent =
        `Class: ${currentClass || ""} | Student / Guardian (å…± ${students.length} äºº) | Present: ${stats.present} | Leave: ${stats.leave} | Absent: ${stats.absent}`;
    }

    // Reset ç­çº§
    function resetClassSelection() {
      currentClass = null;
      students = [];
      stats = { present: 0, leave: 0, absent: 0 };

      // Loop all the buttons
      document.querySelectorAll("#classButtons button").forEach(b => {
        if (b.textContent !== "Reset") {
          b.disabled = false;
          b.classList.remove("disabled", "present");
        }
      });

      document.getElementById("attendanceTable").querySelector("tbody").innerHTML = "";
      document.getElementById("stats").textContent = "Student / Guardian";
    }

    // æäº¤é¢„è§ˆ
    function previewSubmission() {
      if (!currentClass || students.length === 0) {
        alert("è¯·å…ˆé€‰æ‹©ç­çº§å¹¶å½•å…¥è€ƒå‹¤ï¼");
        return;
      }

      let summary = `Class: ${currentClass}\n\n`;
      students.forEach((stu, i) => {
        summary += `${stu.studentName} (${stu.studentId || "NoID"}, ${stu.gender || "-"}) : ${stu.status || "æœªæ‰“å¡"} | Notes: ${document.getElementById("note-"+i).value}\n`;
      });
      alert(summary);
    }

    // æäº¤å…¨ç­æ‰“å¡
    async function submitAll() {
      if (!currentClass || students.length === 0) {
        alert("è¯·å…ˆé€‰æ‹©ç­çº§å¹¶å½•å…¥è€ƒå‹¤ï¼");
        return;
      }

      const today = new Date().toISOString().slice(0,10);
      const btn = document.getElementById("submitBtn");  // Locate the submit button

      // === Step 1: Disable button to avoid duplicated submission ===
      ifï¼ˆbtn) {
        btn.disabled = true;
        btn.textConent = "æäº¤ä¸­... / Submitting...";     
      }
      
      try {
        const records = students.map((stu, i) => ({
          date: today,
          className: currentClass,
          studentId: stu.studentId || "",
          studentName: stu.studentName,
          gender: stu.gender || "",
          status: stu.status || "",
          notes: document.getElementById("note-"+i).value || ""
        }));        
        
        const res = await fetch(`${API_URL}`, {
          method: "POST",
          //headers: { "Content-Type": "application/json" },
          headers: {"Content-Type": "text/plain"},
          body: JSON.stringify({ records })
        });

        const result = await res.json();
        if (result.ok) {
          alert("æäº¤æˆåŠŸï¼å†™å…¥ " + result.count + " æ¡è®°å½•ã€‚");
        } else {
          alert("æäº¤å¤±è´¥: " + result.error);
        }
      } catch (err) {
        alert("ç½‘ç»œé”™è¯¯: " + err.message);
      } finally {
        // === Step 2: Restore the button ===
        btn.disabled = false;
        btn.textContent = "æäº¤ / Submit";
      }
    }

    window.onload = loadClasses;
  </script>
</body>
</html>
