<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>班级打卡 Attendance</title>
<style>
  body { font-family: Arial, "STSong-Light", sans-serif; margin: 10px; background: #f8f9fa; }
  h2 { color: #0d47a1; }
  .class-buttons { margin: 10px 0; }
  button { margin: 3px; padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; font-size: 14px; }
  .btn-present { background: #0d9488; color: white; }
  .btn-leave { background: #f97316; color: white; }
  .btn-absent { background: #dc2626; color: white; }
  .btn-reset { background: #6b7280; color: white; }
  .disabled { opacity: 0.5; cursor: not-allowed; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; }
  th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
  th { background: #e3f2fd; }
  tr:nth-child(odd) { background: #f9f9f9; }
</style>
</head>
<body>

<h2>班级打卡 Attendance</h2>

<div class="class-buttons" id="classButtons"></div>

<table id="attendanceTable">
  <thead>
    <tr>
      <th id="tableHeader">Student / Guardian</th>
      <th>Present</th>
      <th>Leave</th>
      <th>Absent</th>
      <th>Notes</th>
      <th>Reset</th>
    </tr>
  </thead>
  <tbody id="studentRows"></tbody>
</table>

<button class="btn-reset" onclick="submitAttendance()">提交全班打卡</button>

<pre id="result"></pre>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbxl3AI6_w0dv3YnrjoVOM6tHuXVZSiSe-_sQ5zA-ax4DPEBvT9pAGZAnvSdvyiMOdbw/exec"; // ⚠️ 改成你的 Apps Script URL

let currentClass = null;
let studentsData = [];
let attendanceMap = {};
let totals = { present: 0, leave: 0, absent: 0 };

async function loadClasses() {
  const res = await fetch(API_URL + "?action=getClasses");
  const data = await res.json();
  if (data.ok) {
    const container = document.getElementById("classButtons");
    container.innerHTML = "";
    data.classes.forEach(cls => {
      const btn = document.createElement("button");
      btn.textContent = cls;
      btn.onclick = () => selectClass(cls, btn);
      container.appendChild(btn);
    });
    const resetBtn = document.createElement("button");
    resetBtn.textContent = "Reset Class";
    resetBtn.className = "btn-reset";
    resetBtn.onclick = resetClass;
    container.appendChild(resetBtn);
  }
}

async function selectClass(cls, btn) {
  currentClass = cls;
  document.querySelectorAll("#classButtons button").forEach(b => {
    if (b.textContent !== "Reset Class") { b.disabled = true; b.classList.add("disabled"); }
  });
  btn.disabled = false;
  btn.classList.remove("disabled");
  const res = await fetch(API_URL + "?action=getStudents&className=" + encodeURIComponent(cls));
  const data = await res.json();
  if (data.ok) {
    studentsData = data.students;
    renderTable();
  }
}

function resetClass() {
  currentClass = null;
  document.getElementById("studentRows").innerHTML = "";
  document.querySelector("#tableHeader").textContent = "Student / Guardian";
  document.querySelectorAll("#classButtons button").forEach(b => { b.disabled = false; b.classList.remove("disabled"); });
  attendanceMap = {};
  updateHeaderStats();
}

function renderTable() {
  const tbody = document.getElementById("studentRows");
  tbody.innerHTML = "";
  attendanceMap = {};
  totals = { present: 0, leave: 0, absent: 0 };

  studentsData.forEach((stu, i) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${stu.studentName} (${stu.gender})<br>${stu.guardianName} ${stu.guardianPhone}</td>
      <td><button class="btn-present" onclick="markAttendance(${i}, 'Present')">Present</button></td>
      <td><button class="btn-leave" ${stu.leave ? "" : ""} onclick="markAttendance(${i}, 'Leave')">Leave</button></td>
      <td><button class="btn-absent" onclick="markAttendance(${i}, 'Absent')">Absent</button></td>
      <td><input type="text" id="note-${i}" placeholder="Notes"></td>
      <td><button class="btn-reset" onclick="resetRow(${i})">Reset</button></td>
    `;
    tbody.appendChild(tr);

    // 如果有请假覆盖
    if (stu.leave) {
      markAttendance(i, "Leave");
    }
  });

  updateHeaderStats();
}

function markAttendance(index, status) {
  const row = document.getElementById("studentRows").children[index];
  const buttons = row.querySelectorAll("button");
  buttons.forEach(b => { b.disabled = true; b.classList.add("disabled"); });
  row.querySelector(`.btn-${status.toLowerCase()}`).disabled = false;
  row.querySelector(`.btn-${status.toLowerCase()}`).classList.remove("disabled");

  const stu = studentsData[index];
  const note = document.getElementById(`note-${index}`).value;

  if (attendanceMap[index]) { totals[attendanceMap[index].status.toLowerCase()]--; }
  attendanceMap[index] = {
    studentId: stu.studentId,
    studentName: stu.studentName,
    gender: stu.gender,
    className: currentClass,
    status: status,
    notes: note
  };
  totals[status.toLowerCase()]++;
  updateHeaderStats();
}

function resetRow(index) {
  const row = document.getElementById("studentRows").children[index];
  const buttons = row.querySelectorAll("button");
  buttons.forEach(b => { b.disabled = false; b.classList.remove("disabled"); });
  if (attendanceMap[index]) {
    totals[attendanceMap[index].status.toLowerCase()]--;
    delete attendanceMap[index];
  }
  updateHeaderStats();
}

function updateHeaderStats() {
  const total = studentsData.length;
  document.getElementById("tableHeader").textContent =
    `Student / Guardian (共 ${total} 人) | Present: ${totals.present} | Leave: ${totals.leave} | Absent: ${totals.absent}`;
}

async function submitAttendance() {
  const records = Object.values(attendanceMap);
  if (!records.length) { alert("没有考勤记录"); return; }

  const res = await fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({ records }),
    headers: { "Content-Type": "application/json" }
  });
  const data = await res.json();
  document.getElementById("result").textContent = JSON.stringify(data, null, 2);
}
loadClasses();
</script>
</body>
</html>
