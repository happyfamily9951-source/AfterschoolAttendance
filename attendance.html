

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Attendance</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 10px; }
    h2 { color: #002060; }
    button {
      margin: 3px;
      padding: 6px 12px;
      font-size: 14px;
      border-radius: 6px;
      cursor: pointer;
    }

    table { border-collapse: collapse; width: 100%; margin-top: 15px; }
    th, td { border: 1px solid #ddd; padding: 6px; text-align: center; }
    th { background-color: #f2f2f2; }
    
    .present { background-color: #28a745; color: white; }
    .leave { background-color: #ff9800; color: white; }
    .absent { background-color: #dc3545; color: white; }
    .disabled { background-color: #ccc; color: #666; pointer-events: none; }
    .reset { background-color: #6c757d; color: white; }

    #stats { margin-top: 15px; font-weight: bold; color: #002060; }

    #submitArea { margin-top: 20px; }
  </style>
</head>

<body>
  <h2>选择班级 / Select Class</h2>
  <div id="classButtons">Loading...</div>

  <div id="stats">Student / Guardian</div>

  <table id="attendanceTable">
    <thead>
      <tr>
        <th>Student / Guardian</th>
        <th>Present</th>
        <th>Leave</th>
        <th>Absent</th>
        <th>Notes</th>
        <th>Reset</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- 提交区域 -->
  <div id="submitArea">
    <button onclick="previewSubmission()">预览提交 / Preview Submission</button>
    <button onclick="submitAll()">提交全班打卡 / Submit All</button>
  </div>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbywt8Y5aqs-NwVU1L-FT_zB4BZXal7Kq3OfwHFkeAp5HyLS8XFit1DIj7F1oifusdBJ/exec";

    let currentClass = null;
    let students = [];
    let stats = { present: 0, leave: 0, absent: 0 };


    // 加载班级按钮
    async function loadClasses() {
      const res = await fetch(`${API_URL}?action=getClasses`);
      const json = await res.json();
      const container = document.getElementById("classButtons");
      container.innerHTML = "";

      json.classes.forEach(cls => {
        const btn = document.createElement("button");
        btn.textContent = cls;
        btn.onclick = () => selectClass(cls, btn);
        container.appendChild(btn);
      });

      const resetBtn = document.createElement("button");
      resetBtn.textContent = "Reset";
      resetBtn.classList.add("reset");
      resetBtn.onclick = resetClassSelection();
      container.appendChild(resetBtn);
    }


    // 选择班级
    async function selectClass(cls, clickedBtn) {
      currentClass = cls;
      stats = { present: 0, leave: 0, absent: 0 };
      
      document.querySelectorAll("#classButtons button").forEach(b => {
        if (b !== clickedBtn && b.textContent !== "Reset") {
          b.disabled = true;
          b.classList.add("disabled");
        } else if (b === clickedBtn) {
          b.classList.add("present");
        }
      });

      try {
        const res = await fetch(`${API_URL}?action=getStudents&className=${encodeURIComponent(cls)}`);
        const json = await res.json();
        students = json.students;
        renderTable(students);
        updateStats();
      } catch (err) {
        console.error("加载学生失败:", err);
        document.getElementById("stats").textContent = "加载学生失败: " + err.message;
      }
    }

    // 渲染学生表格
    function renderTable(students) {
      const tbody = document.getElementById("attendanceTable").querySelector("tbody");
      tbody.innerHTML = "";

      students.forEach((stu, i) => {
        const tr = document.createElement("tr");
        const tdName = document.createElement("td");

        tdName.textContent = `${stu.studentName} / ${stu.guardianName} (${stu.guardianPhone})`;
        tr.appendChild(tdName);

        const tdPresent = document.createElement("td");
        const btnPresent = document.createElement("button");
        btnPresent.textContent = "Present";
        btnPresent.className = "present";
        btnPresent.onclick = () => markAttendance(i, "present", btnPresent);
        tdPresent.appendChild(btnPresent);
        tr.appendChild(tdPresent);

        const tdLeave = document.createElement("td");
        const btnLeave = document.createElement("button");
        btnLeave.textContent = "Leave";
        btnLeave.className = "leave";
        btnLeave.onclick = () => markAttendance(i, "leave", btnLeave);
        tdLeave.appendChild(btnLeave);
        tr.appendChild(tdLeave);

        const tdAbsent = document.createElement("td");
        const btnAbsent = document.createElement("button");
        btnAbsent.textContent = "Absent";
        btnAbsent.className = "absent";
        btnAbsent.onclick = () => markAttendance(i, "absent", btnAbsent);
        tdAbsent.appendChild(btnAbsent);
        tr.appendChild(tdAbsent);

        const tdNotes = document.createElement("td");
        const noteInput = document.createElement("input");
        noteInput.type = "text";
        noteInput.id = `note-${i}`;
        noteInput.value = stu.notes || ""; 
        tdNotes.appendChild(noteInput);
        tr.appendChild(tdNotes);

        const tdReset = document.createElement("td");
        const btnReset = document.createElement("button");
        btnReset.textContent = "Reset";
        btnReset.className = "reset";
        btnReset.onclick = () => resetRow(i, tr);
        tdReset.appendChild(btnReset);
        tr.appendChild(tdReset);

        // Highlight button based on stu.status
        if (stu.status) {
          let activeBtn = null;
          if (stu.status === "present") activeBtn = btnPresent;
          if (stu.status === "leave") activeBtn = btnLeave;
          if (stu.status === "absent") activeBtn = btnAbsent;

          if (activeBtn) {
            activeBtn.disabled = true; // 
            [btnPresent, btnLeave, btnAbsent].forEach( b=> {
              if (b!= activeBtn) {
                b.disabled = true;
                b.classList.add("disabled");
              }
            });
          }
        }
        
        tbody.appendChild(tr);
      });
    }

    // 点击状态按钮
    function markAttendance(index, type, clickedBtn) {
      const row = clickedBtn.parentNode.parentNode;
      const buttons = row.querySelectorAll("button");

      buttons.forEach(b => {
        if (!b.classList.contains("reset")) {
          b.disabled = false;
          b.classList.remove("disabled");
        }
      });

      clickedBtn.disabled = true;
      students[index].status = type;
      updateStats();
    }

    // Reset 单行
    function resetRow(index, row) {
      const buttons = row.querySelectorAll("button");
      buttons.forEach(b => {
        if (!b.classList.contains("reset")) {
          b.disabled = false;
          b.classList.remove("disabled");
        }
      });

      students[index].status = null;
      updateStats();
    }

    // 更新统计
    function updateStats() {
      stats = { present: 0, leave: 0, absent: 0 };
      students.forEach(stu => {
        if (stu.status === "present") stats.present++;
        if (stu.status === "leave") stats.leave++;
        if (stu.status === "absent") stats.absent++;
      });
      
      document.getElementById("stats").textContent =
        `Class: ${currentClass || ""} | Student / Guardian (共 ${students.length} 人) | Present: ${stats.present} | Leave: ${stats.leave} | Absent: ${stats.absent}`;
    }

    // Reset 班级
    function resetClassSelection() {
      currentClass = null;
      students = [];
      stats = { present: 0, leave: 0, absent: 0 };

      document.querySelectorAll("#classButtons button").forEach(b => {
        b.disabled = false;
        b.classList.remove("disabled", "present");
      });

      document.getElementById("attendanceTable").querySelector("tbody").innerHTML = "";
      document.getElementById("stats").textContent = "Student / Guardian";
    }

    // 提交预览
    function previewSubmission() {
      if (!currentClass || students.length === 0) {
        alert("请先选择班级并录入考勤！");
        return;
      }

      let summary = `Class: ${currentClass}\n\n`;
      students.forEach((stu, i) => {
        summary += `${stu.studentName} (${stu.studentId || "NoID"}, ${stu.gender || "-"}) : ${stu.status || "未打卡"} | Notes: ${document.getElementById("note-"+i).value}\n`;
      });
      alert(summary);
    }

    // 提交全班打卡
    async function submitAll() {
      if (!currentClass || students.length === 0) {
        alert("请先选择班级并录入考勤！");
        return;
      }

      const today = new Date().toISOString().slice(0,10);
      
      const records = students.map((stu, i) => ({
        date: today,
        className: currentClass,
        studentId: stu.studentId || "",
        studentName: stu.studentName,
        gender: stu.gender || "",
        status: stu.status || "",
        notes: document.getElementById("note-"+i).value || ""
      }));

      try {
        const res = await fetch(`${API_URL}`, {
          method: "POST",
          //headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ records })
        });

        const result = await res.json();
        if (result.ok) {
          alert("提交成功！写入 " + result.count + " 条记录。");
        } else {
          alert("提交失败: " + result.error);
        }
      } catch (err) {
        alert("网络错误: " + err.message);
      }
    }

    window.onload = loadClasses;
  </script>
</body>
</html>
