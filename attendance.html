<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Attendance</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 10px; }
    h2 { color: #002060; }
    button { margin: 3px; padding: 6px 12px; font-size: 14px; border-radius: 6px; cursor: pointer; }
    table { border-collapse: collapse; width: 100%; margin-top: 15px; }
    th, td { border: 1px solid #ddd; padding: 6px; text-align: center; }
    th { background-color: #f2f2f2; }
    .present { background-color: #28a745; color: white; }
    .leave { background-color: #ff9800; color: white; }
    .absent { background-color: #dc3545; color: white; }
    .disabled { background-color: #ccc; color: #666; pointer-events: none; }
    .reset { background-color: #6c757d; color: white; }
    #stats { margin-top: 15px; font-weight: bold; color: #002060; }
  </style>
</head>

/* This is the baseline version 
  Check list before commiting changes to github
  1. API_URL is updated?
  2. Fix the found bugs? */
  
<body>
  <h2>选择班级 / Select Class</h2>
  <div id="classButtons">Loading...</div>

  <div id="stats">Student / Guardian</div>

  <table id="attendanceTable">
    <thead>
      <tr>
        <th>Student / Guardian</th>
        <th>Present</th>
        <th>Leave</th>
        <th>Absent</th>
        <th>Notes</th>
        <th>Reset</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbywt8Y5aqs-NwVU1L-FT_zB4BZXal7Kq3OfwHFkeAp5HyLS8XFit1DIj7F1oifusdBJ/exec";

    let currentClass = null;
    let students = [];
    let stats = { present: 0, leave: 0, absent: 0 };

    async function loadClasses() {
      try {
        const res = await fetch(`${API_URL}?action=getClasses`);
        const data = await res.json();
        if (data.ok) {
          const container = document.getElementById("classButtons");
          container.innerHTML = "";
          data.classes.forEach(cls => {
            const btn = document.createElement("button");
            btn.textContent = cls;
            btn.onclick = () => selectClass(cls);
            container.appendChild(btn);
          });
        }
      } catch (err) {
        document.getElementById("classButtons").textContent = "加载失败: " + err;
      }
    }

    async function selectClass(cls) {
      currentClass = cls;
      stats = { present: 0, leave: 0, absent: 0 };
      document.getElementById("stats").textContent = "Student / Guardian";
      try {
        const res = await fetch(`${API_URL}?action=getStudents&className=${encodeURIComponent(cls)}`);
        const data = await res.json();
        if (data.ok) {
          students = data.students;
          renderTable();
        }
      } catch (err) {
        alert("加载学生失败: " + err);
      }
    }

    function renderTable() {
      const tbody = document.querySelector("#attendanceTable tbody");
      tbody.innerHTML = "";

      students.forEach((stu, i) => {
        const tr = document.createElement("tr");

        const td1 = document.createElement("td");
        td1.textContent = `${stu.studentName} (${stu.guardianName} ${stu.guardianPhone})`;
        tr.appendChild(td1);

        const td2 = document.createElement("td");
        const btnP = document.createElement("button");
        btnP.textContent = "Present";
        btnP.classList.add("present");
        btnP.onclick = () => markAttendance(i, "Present");
        td2.appendChild(btnP);
        tr.appendChild(td2);

        const td3 = document.createElement("td");
        const btnL = document.createElement("button");
        btnL.textContent = "Leave";
        btnL.classList.add("leave");
        btnL.onclick = () => markAttendance(i, "Leave");
        td3.appendChild(btnL);
        tr.appendChild(td3);

        const td4 = document.createElement("td");
        const btnA = document.createElement("button");
        btnA.textContent = "Absent";
        btnA.classList.add("absent");
        btnA.onclick = () => markAttendance(i, "Absent");
        td4.appendChild(btnA);
        tr.appendChild(td4);

        const td5 = document.createElement("td");
        const noteInput = document.createElement("input");
        noteInput.type = "text";
        noteInput.id = `note-${i}`;
        noteInput.value = stu.notes || "";
        td5.appendChild(noteInput);
        tr.appendChild(td5);

        const td6 = document.createElement("td");
        const btnR = document.createElement("button");
        btnR.textContent = "Reset";
        btnR.classList.add("reset");
        btnR.onclick = () => resetRow(i);
        td6.appendChild(btnR);
        tr.appendChild(td6);

        tbody.appendChild(tr);

        // 如果有请假覆盖
        if (stu.leave) {
          markAttendance(i, "Leave");
          if (stu.notes) document.getElementById(`note-${i}`).value = stu.notes;
        }
      });

      updateStats();
    }

    function markAttendance(i, status) {
      const row = document.querySelector("#attendanceTable tbody").rows[i];
      ["present", "leave", "absent"].forEach((cls, idx) => {
        const btn = row.cells[idx+1].querySelector("button");
        btn.classList.remove("disabled");
      });

      const btn = row.querySelector(`.${status.toLowerCase()}`);
      btn.classList.add("disabled");

      students[i].status = status;
      updateStats();
    }

    function resetRow(i) {
      students[i].status = "";
      const row = document.querySelector("#attendanceTable tbody").rows[i];
      ["present", "leave", "absent"].forEach((cls, idx) => {
        const btn = row.cells[idx+1].querySelector("button");
        btn.classList.remove("disabled");
      });
      updateStats();
    }

    function updateStats() {
      stats = { present: 0, leave: 0, absent: 0 };
      students.forEach(s => {
        if (s.status === "Present") stats.present++;
        if (s.status === "Leave") stats.leave++;
        if (s.status === "Absent") stats.absent++;
      });
      document.getElementById("stats").textContent =
        `Student / Guardian (共 ${students.length} 人) | Present: ${stats.present} | Leave: ${stats.leave} | Absent: ${stats.absent}`;
    }

    window.onload = loadClasses;
  </script>
</body>
</html>
