<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Enrollment</title>
    <link rel="stylesheet" href="style.css">
    <script src="config.js"></script>
  </head>
  
  <body class="page-course">
    <div class="logo-container">
      <!-- Logo on the top left -->
      <img src="icons/logo-monica-linan.svg" alt="Logo" class="logo-top-left">
    </div>

    <main class="page-content">
      <!-- Create class -->
      <div class="form-container">
        <h2>Create New Class</h2>
        <!-- 1st row: class Name -->
        <label for="className">Class Name</label>
        <input type="text" id="className" placeholder="Enter class name" required>
        
        <!-- 2nd row: short description -->
        <label for="classShortDescription">Class Short Description</label>
        <input type="text" id="classShortDescription" placeholder="Enter description" required>
        
        <!-- 3rd row: Date From and Date To -->
        <div class="row">
          <div class="col">
            <label for="dateFrom">Date From</label>
            <input type="date" id="dateFrom" required>
          </div>
          <div class="col">
            <label for="dateTo">Date To</label>
            <input type="date" id="dateTo" required>
          </div>
        </div>
        
        <!-- 4th row: Time From and Time To -->
        <div class="row">
          <div class="col">
            <label for="timeFrom">Time From</label>
            <input type="time" id="timeFrom" required>
          </div>
          <div class="col">
            <label for="timeTo">Time To</label>
            <input type="time" id="timeTo" required>
          </div>
        </div>
        
        <!-- 5th row: Age From and Age To -->
        <div class="row">
          <div class="col">
            <label for="ageFrom">Age From</label>
            <input type="number" id="ageFrom" min="1">
          </div>
          <div class="col">
            <label for="ageTo">Age To</label>
            <input type="number" id="ageTo" min="1" max="18">
          </div>
        </div>
        
        <!-- 6th row: DayOfWeek and Max Position -->
        <div class="row">
          <div class="col">
            <label for="dayOfWeek">Day of Week</label>
            <select id="dayOfWeek" required>
              <option value="">Select</option>
              <option value="Mon">Monday</option>
              <option value="Tue">Tuesday</option>
              <option value="Wed">Wednesday</option>
              <option value="Thu">Thursday</option>
              <option value="Fri">Friday</option>
              <option value="Sat">Saturday</option>
              <option value="Sun">Sunday</option>
            </select>
          </div>
          <div class="col">
            <label for="maxPositions">Maximum Positions</label>
            <input type="number" id="maxPositions" min="1">
          </div>
        </div>
        
        <!-- 7th row: Teacher name -->
        <label for="teacherName">Teacher Name</label>
        <input type="text" id="teacherName" placeholder="Enter teacher's name" required>
        
        <!-- 8th row: Teacher number and email -->
        <div class="row">
          <div class="col">
            <label for="teacherPhone">Teacher Phone Number</label>
            <input type="tel" id="teacherPhone" placeholder="Enter teacher phone number" required>
          </div>
          <div class="col">
            <label for="teacherEmail">Teacher Email</label>
            <input type="email" id="teacherEmail" placeholder="Enter teacher email">
          </div>
        </div>
        
        <button class="btn-primary" id="CourseSubmit" onclick="submitCourse()">Submit</button>
      </div>
      
      <!-- Search class -->
      <div class="form-container">
        <h2>Course Search</h2>

        <!-- Input box and button -->
        <div class="row">
          <div class="col">
            <input type="text" id="searchCourse" placeholder="Enter course name">
          </div>
          <div>
            <button class="btn-primary" id="CourseSearchBtn" onclick="searchCourse()">Search</button>
          </div>
        </div>

        <!-- Search Results -->
        <div id="searchResult" style="margin-top:12px;"></div>
      </div>      
    </main>
      
    <!-- Notification -->
    <div id="notification" class="notification hidden"></div>
        
    <!-- Nagivator button on the bottom -->
    <nav class="bottom-nav">
      <a class="nav-item nav-student active" href="StudentEnrollment.html" aria-label="Student Enrollment">
        <img src="icons/student-enroll.svg" alt="">
      </a>
      <a class="nav-item nav-course" href="CourseEnrollment.html" aria-label="Course Enrollment">
        <img src="icons/course-enroll.svg" alt="">
      </a>
      <a class="nav-item nav-student-course-application" href="StudentCourseApplication.html" aria-label="Student Course Application">
        <img src="icons/student-course-application.svg" alt="">
      </a>    
      <a class="nav-item nav-attend" href="Attendance.html" aria-label="Attendance">
        <img src="icons/attendance.svg" alt="">
      </a>
      <a class="nav-item nav-report" href="Report.html" aria-label="Reports">
        <img src="icons/report.svg" alt="">
      </a>
    </nav>
    
    <script>
      async function submitCourse() {
        const btn = document.getElementById("CourseSubmit");
        btn.disabled = true;
        const originalText=btn.innerText;
        btn.innerText="Submitting..."

        // Version A: x-www-form-urlencoded
        // Step A1: Read values
        const data = {
          action: "addCourse",
          className: className.value.trim(),
          classShortNotes: classShortDescription.value.trim(),
          dateFrom: dateFrom.value.trim(),
          dateTo: dateTo.value.trim(),
          timeFrom: timeFrom.value.trim(),
          timeTo: timeTo.value.trim(),
          ageFrom: ageFrom.value.trim(),
          ageTo: ageTo.value.trim(),
          dayOfWeek: dayOfWeek.value.trim(),
          maxPositions: maxPositions.value.trim(),
          teacherName: teacherName.value.trim(),
          teacherPhone: teacherPhone.value.trim(),
          teacherEmail: teacherEmail.value.trim()
        };

        const body = Object.keys(data)
          .map(k=> `${encodeURIComponent(k)}=${encodeURIComponent(data[k])}`)
          .join("&");
        
        try {
          const resp = await fetch(API_URL, {
            method: "POST",
            headers: {"Content-Type" : "application/x-www-form-urlencoded;charset=UTF-8"},
            body
          });
          
          const result = await resp.json();
          if (result.ok) {
            showNotification(`‚úÖ Course added successful`, "success");            
            document.getElementById("classForm").reset();
          } else {
            showNotification(`‚ùå Error: ${result.message || "Unknown error"}`, "error");
          }
        } catch (e) {
          showNotification("‚ùå Network error: " + e.message, "error");          
        } finally {
          btn.disabled = false;
          btn.innerText = originalText;
        }
      }
      
      async function searchCourse() {
        const btn = document.getElementById("CourseSearchBtn");
        const name=document.getElementById("searchCourse").value.trim();
        
        if (!name) {
          alert("Please input the course name");
          return;
        }
        
        btn.disabled = true;
        const originalText = btn.innerText;
        btn.innerText="Searching...";

        const container = document.getElementById("searchResult");

        try {
          const resp = await fetch(`${API_URL}?action=searchCourseByName&name=${encodeURIComponent(name)}`);
          const result = await resp.json();
          
          if (result.ok && result.results && result.results.length > 0) {
            result.results.forEach(s=> {
              const card = document.createElement("div");
              card.className="student-card";

              //header: className + dayOfWeek
              const header = document.createElement("div");
              header.className="student-header";
              header.innerHTML = `
                <div><strong>Class name: </strong>${s.className || ""}</div>
                <div>${s.dayOfWeek} || ""</div>
              `;

              //Details: hiding in default
              const details = document.createElement("div");
              details.className = "student-details";
              details.style.display = "none";
              details.innerHTML = `
                <div class="row">
                  <div class="col"><strong>Description: </strong> ${s.classShortDescription}</div>
                </div>
                <div class="row">
                  <div class="col"<strong>Date: </strong> ${s.dateFrom || ""} ~ ${s.dateTo || ""}</div>
                </div>
                <div class="row">
                  <div class="col"><strong>Day: </strong> ${s.dayOfWeek || ""}</div>
                  <div class="col"><strong>Max Positions: </strong> ${s.maxPositions ||""}</div>
                </div>
                <div class="row">
                  <div class="col">
                    <strong>Teacher</strong> ${s.teacherName ||""} / ${s.teacherPhone || ""}
                    <span class="contact-actions">
                      <button onclick="callNumber('${s.teacherPhone || ""}')">üìû</button>
                      <button onclick="smsNumber('${s.teacherPhone || ""}')">üí¨</button>
                    </span>
                  </div>
                </div>
              `;

              //Click to expand
              header.addEventListener("click", () => {
                const expanded = details.style.display === "block";

                //Collaps other cards
                document.querySelectorAll(".student-details").forEach(d=>d.style.display="none");
                document.querySelectorAll(".student-header").forEach(h => h.classList.remove("selected"));

                //Expand the current one
                if (!expanded) {
                  details.style.display = "block";
                  header.classList.add("selected");
                }
              });

              card.appendChild(header);
              card.appendChild(details);

              container.appendChild(card);
            });
                  
              
                          
          } else {
            showNotification("‚ö†Ô∏è No matching class found", "error");
            document.getByElement("classResults").innerHTML = "";
          }
        } catch (e) {
          showNotification("‚ùå Network error: " + e.message, "error"); 
        } finally {
          btn.disabled = false;
          btn.innerText = originalText;
        }
      }        
    </script>
  </body>
</html>
