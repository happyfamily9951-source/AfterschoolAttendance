<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Course Application</title>
  <link rel="stylesheet" href="style.css">
  <script src="config.js"></script>

  <style>
    /* ===== Search Student ÁÆÄÊ¥ÅÂ∏ÉÂ±Ä ===== */
    .student-line {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 8px;
      border-bottom: 1px solid #eee;
      font-size: 15px;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .student-line:hover {
      background: #f9fafb;
    }

    .student-line.selected {
      background: #e0f2fe;
    }

    .student-line input[type="checkbox"] {
      transform: scale(1.1);
      cursor: pointer;
    }

    .student-name {
      flex: 1;
    }

    .student-gender-icon {
      font-size: 18px;
      opacity: 0.8;
    }

    /* ===== Accordion Ê†∑Âºè ===== */
    .accordion-section {
      border: 1px solid #ddd;
      border-radius: 10px;
      margin-top: 8px;
      background: #fff;
    }

    .accordion-header {
      padding: 10px 12px;
      background: #f9fafb;
      cursor: pointer;
      font-weight: 600;
      border-bottom: 1px solid #e5e7eb;
    }

    .accordion-content {
      display: none;
      padding: 8px 12px;
    }

    .accordion-content.open {
      display: block;
    }

    .course-item {
      margin: 4px 0;
      padding: 6px 10px;
      border-radius: 6px;
      transition: background 0.2s ease;
    }

    .course-item.selected {
      background-color: #e0f2fe;
      border-left: 3px solid #3b82f6;
    }

    /* ===== ÈÄöÁü•Âå∫Âüü ===== */
    .notification {
      min-height: 20px;
      margin-bottom: 6px;
      position: relative;
    }

    .notification-inner {
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 14px;
      opacity: 0;
      transform: translateY(-5px);
      transition: all 0.4s ease;
    }

    .notification-inner.show {
      opacity: 1;
      transform: translateY(0);
    }

    .notification-inner.success { background: #dcfce7; color: #166534; }
    .notification-inner.error { background: #fee2e2; color: #b91c1c; }
    .notification-inner.info { background: #e0f2fe; color: #075985; }
  </style>
</head>

<body class="page-student-course">
  <!-- Â∑¶‰∏äËßíÂ∞è Logo -->
  <img src="icons/logo-monica-linan.svg" alt="Logo" class="logo-top-left">

  <main class="page-content">
    
    <!-- Container 1: Search Student -->
    <div class="form-container">
      <h2>Search Student</h2>
      <div id="notificationSearch" class="notification"></div>

      <div class="row">
        <div class="col">
          <input type="text" id="searchName" placeholder="Enter student's name">
        </div>
        <div>
          <button class="btn-primary" id="SearchBtn" onclick="searchStudent()">Search</button>
        </div>
      </div>

      <div id="searchResult" style="margin-top:12px;"></div>
    </div>

    <!-- Container 2: Select Course by DayOfWeek -->
    <div class="form-container">
      <h2>Select Course by Day of Week</h2>
      <div id="notificationApply" class="notification"></div>

      <div id="courseAccordion" class="accordion"></div>

      <button class="btn-primary" id="ApplySubmit" disabled onclick="submitApplication()">Submit Application</button>
    </div>

  </main>

  <!-- Â∫ïÈÉ®ÂØºËà™Ê†è -->
  <nav class="bottom-nav">
    <a class="nav-item nav-student" href="StudentEnrollment.html">
      <img src="icons/student-enroll.svg" alt="">
    </a>
    <a class="nav-item nav-course" href="CourseEnrollment.html">
      <img src="icons/course-enroll.svg" alt="">
    </a>
    <a class="nav-item nav-student-course-application active" href="StudentCourseApplication.html">
      <img src="icons/student-course-application.svg" alt="">
    </a>    
    <a class="nav-item nav-attend" href="Attendance.html">
      <img src="icons/attendance.svg" alt="">
    </a>
    <a class="nav-item nav-report" href="Report.html">
      <img src="icons/report.svg" alt="">
    </a>
  </nav>

  <script>
    let selectedStudentId = null;
    const selectedCourses = {}; // { Monday: classId, Tuesday: classId, ... }

    // ‚úÖ ÊÄßÂà´ÂõæÊ†áÂáΩÊï∞
    function genderIcon(g) {
      const t = (g || "").toString().toUpperCase();
      if (t === "M" || t === "MALE") return "üë¶";
      if (t === "F" || t === "FEMALE") return "üëß";
      return "‚ö™";
    }

    // ‚úÖ ÊêúÁ¥¢Â≠¶Áîü
    async function searchStudent() {
      const btn = document.getElementById("SearchBtn");
      const name = document.getElementById("searchName").value.trim();
      const container = document.getElementById("searchResult");

      if (!name) { 
        showNotification("Please enter a student name", "error", "notificationSearch");
        return; 
      }

      btn.disabled = true; btn.innerText = "Searching..."; container.innerHTML = "";
      try {
        const response = await fetch(`${API_URL}?action=searchStudentByName&name=${encodeURIComponent(name)}`);
        const result = await response.json();

        if (result.ok && result.results && result.results.length > 0) {
          container.innerHTML = "";
          result.results.forEach(s => {
            const label = document.createElement("label");
            label.className = "student-line";
            label.innerHTML = `
              <input type="checkbox" name="studentSingle" value="${s.studentId}">
              <span class="student-name">${s.studentName}</span>
              <span class="student-gender-icon">${genderIcon(s.gender)}</span>
            `;
            const ck = label.querySelector("input");
            ck.addEventListener("change", () => onSelectStudent(ck, label));
            container.appendChild(label);
          });
          showNotification("‚úÖ Students loaded successfully", "success", "notificationSearch");
        } else {
          container.innerHTML = `<p style="color:red">No student found</p>`;
          showNotification("‚ùå No matching student", "error", "notificationSearch");
        }
      } catch (err) {
        showNotification("‚ö†Ô∏è Network error: " + err.message, "error", "notificationSearch");
      } finally {
        btn.disabled = false; btn.innerText = "Search";
      }
    }

    function onSelectStudent(ck, label) {
      document.querySelectorAll("#searchResult input[name='studentSingle']").forEach(n => {
        if (n !== ck) n.checked = false;
      });
      document.querySelectorAll(".student-line").forEach(l => l.classList.remove("selected"));
      if (ck.checked) {
        label.classList.add("selected");
        selectedStudentId = ck.value;
      } else {
        selectedStudentId = null;
      }
      updateSubmitState();
    }

    // ‚úÖ Âä†ËΩΩËØæÁ®ãÔºàÊåâ dayOfWeek ÊäòÂè†Ôºâ
    document.addEventListener("DOMContentLoaded", loadCourses);

    async function loadCourses() {
      const acc = document.getElementById("courseAccordion");
      acc.innerHTML = "<p>Loading courses...</p>";
      try {
        // const body = new URLSearchParams({ action: "listActiveCourses" });
        const body = new URLSearchParams({ action: "getActiveClasses" });        
        const res = await fetch(API_URL, { method:"POST", headers:{"Content-Type":"application/x-www-form-urlencoded"}, body });
        const list = await res.json();

        acc.innerHTML = "";
        const map = {};
        list.results.forEach(c => {
          const day = c.dayOfWeek || "Unassigned";
          if (!map[day]) map[day] = [];
          map[day].push(c);
        });

        Object.keys(map).forEach(day => {
          const section = document.createElement("div");
          section.className = "accordion-section";
          const header = document.createElement("div");
          header.className = "accordion-header";
          header.textContent = `${day} (${map[day].length} classes)`;
          const content = document.createElement("div");
          content.className = "accordion-content";

          map[day].forEach(c => {
            const item = document.createElement("div");
            item.className = "course-item";
            item.innerHTML = `
              <label>
                <input type="checkbox" name="course-${day}" value="${c.classId}">
                <strong>${c.className}</strong> ${c.startTime} - ${c.endTime} (${c.location})
              </label>
            `;
            const ck = item.querySelector("input");
            ck.addEventListener("change", () => onSelectCourse(day, ck, item));
            content.appendChild(item);
          });

          header.addEventListener("click", () => content.classList.toggle("open"));
          section.appendChild(header);
          section.appendChild(content);
          acc.appendChild(section);
        });
        showNotification("‚úÖ Courses loaded successfully", "success", "notificationApply");
      } catch (err) {
        showNotification("‚ö†Ô∏è Failed to load courses: " + err.message, "error", "notificationApply");
      }
    }

    function onSelectCourse(day, ck, item) {
      document.querySelectorAll(`input[name='course-${day}']`).forEach(n => {
        if (n !== ck) n.checked = false;
      });
      document.querySelectorAll(`.accordion-content .course-item`).forEach(i => i.classList.remove("selected"));
      if (ck.checked) {
        item.classList.add("selected");
        selectedCourses[day] = ck.value;
      } else {
        delete selectedCourses[day];
      }
      updateSubmitState();
    }

    function updateSubmitState() {
      const btn = document.getElementById("ApplySubmit");
      btn.disabled = !(selectedStudentId && Object.keys(selectedCourses).length > 0);
    }

    // ‚úÖ Êèê‰∫§Êä•Âêç
    async function submitApplication() {
      if (!selectedStudentId || Object.keys(selectedCourses).length === 0) return;
      const btn = document.getElementById("ApplySubmit");
      btn.disabled = true; btn.innerText = "Submitting...";

      try {
        for (const [day, classId] of Object.entries(selectedCourses)) {
          const body = new URLSearchParams({
            action: "applyStudentToClass",
            studentId: selectedStudentId,
            classId: classId
          });
          await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body
          });
        }
        showNotification("‚úÖ Application submitted successfully!", "success", "notificationApply");
        document.getElementById("searchResult").innerHTML = "";
        document.getElementById("courseAccordion").querySelectorAll("input[type='checkbox']").forEach(c => c.checked = false);
        for (let k in selectedCourses) delete selectedCourses[k];
        selectedStudentId = null;
        updateSubmitState();
      } catch (err) {
        showNotification("‚ùå Submission failed: " + err.message, "error", "notificationApply");
      } finally {
        btn.disabled = false; btn.innerText = "Submit Application";
      }
    }
  </script>
</body>
</html>
