<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Course Application</title>
  <link rel="stylesheet" href="style.css">
  <script src="config.js"></script>

  <style>
    /* ===== Áªü‰∏ÄÂç°ÁâáÊ†∑ÂºèÔºàÂ≠¶Áîü & ËØæÁ®ãÔºâ ===== */
    .selectable-card {
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 10px 12px;
      margin-top: 6px;
      background: #fff;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .selectable-card:hover { background: #f9fafb; }
    .selectable-card.selected {
      background: #e0f2fe;
      border-color: #3b82f6;
      box-shadow: 0 0 0 2px #bfdbfe;
    }
    .card-line {
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 15px;
    }
    .card-title {
      font-weight: 500;
      color: #111827;
    }
    .card-sub {
      font-size: 13px;
      color: #6b7280;
      margin-top: 3px;
    }
    .gender-icon {
      width: 20px;
      height: 20px;
      opacity: 0.85;
    }

    /* ===== Accordion Ê†∑Âºè ===== */
    .accordion-section {
      border: 1px solid #ddd;
      border-radius: 10px;
      margin-top: 8px;
      background: #fff;
      overflow: hidden;
    }
    .accordion-header {
      padding: 10px 12px;
      background: #f9fafb;
      cursor: pointer;
      font-weight: 600;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .accordion-header:hover { background: #f3f4f6; }
    .accordion-content {
      display: none;
      padding: 8px 12px;
    }
    .accordion-content.open { display: block; }

    /* ===== ÈÄöÁü•Âå∫Âüü ===== */
    .notification {
      min-height: 20px;
      margin-bottom: 6px;
      position: relative;
    }
    .notification-inner {
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 14px;
      opacity: 0;
      transform: translateY(-5px);
      transition: all 0.4s ease;
    }
    .notification-inner.show {
      opacity: 1;
      transform: translateY(0);
    }
    .notification-inner.success { background: #dcfce7; color: #166534; }
    .notification-inner.error { background: #fee2e2; color: #b91c1c; }
    .notification-inner.info { background: #e0f2fe; color: #075985; }
  </style>
</head>

<body class="page-student-course">
  <img src="icons/logo-monica-linan.svg" alt="Logo" class="logo-top-left">

  <main class="page-content">

    <!-- Container 1: Search Student -->
    <div class="form-container">
      <h2>Search Student</h2>
      <div id="notificationSearch" class="notification"></div>

      <div class="row">
        <div class="col">
          <input type="text" id="searchName" placeholder="Enter student's name">
        </div>
        <div>
          <button class="btn-primary" id="SearchBtn" onclick="searchStudent()">Search</button>
        </div>
      </div>

      <div id="searchResult" style="margin-top:12px;"></div>
    </div>

    <!-- Container 2: Select Courses -->
    <div class="form-container">
      <h2>Select Classes</h2>
      <div id="notificationApply" class="notification"></div>

      <div id="courseAccordion"></div>

      <button class="btn-primary" id="ApplySubmit" disabled onclick="submitApplication()">Submit Application</button>
    </div>

  </main>

  <!-- Â∫ïÈÉ®ÂØºËà™ -->
  <nav class="bottom-nav">
    <a class="nav-item nav-student" href="StudentEnrollment.html"><img src="icons/student-enroll.svg" alt=""></a>
    <a class="nav-item nav-course" href="CourseEnrollment.html"><img src="icons/course-enroll.svg" alt=""></a>
    <a class="nav-item nav-student-course-application active" href="StudentCourseApplication.html"><img src="icons/student-course-application.svg" alt=""></a>
    <a class="nav-item nav-attend" href="Attendance.html"><img src="icons/attendance.svg" alt=""></a>
    <a class="nav-item nav-report" href="Report.html"><img src="icons/report.svg" alt=""></a>
  </nav>

  <script>
    let selectedStudentId = null;
    const selectedCourses = {}; // { Monday: classId, Tuesday: classId, ... }

    // ÊÄßÂà´ÂõæÊ†á
    function genderIcon(g) {
      const t = (g || "").toString().toUpperCase();
      if (t === "M" || t === "MALE") return `<img src="icons/male.svg" alt="male" class="gender-icon">`;
      if (t === "F" || t === "FEMALE") return `<img src="icons/female.svg" alt="female" class="gender-icon">`;
      return `<img src="icons/neutral.svg" alt="unknown" class="gender-icon">`;
    }

    // ÊêúÁ¥¢Â≠¶Áîü
    async function searchStudent() {
      const btn = document.getElementById("SearchBtn");
      const name = document.getElementById("searchName").value.trim();
      const container = document.getElementById("searchResult");
      if (!name) {
        showNotification("Please enter a student name", "error", "notificationSearch");
        return;
      }

      btn.disabled = true; btn.innerText = "Searching..."; container.innerHTML = "";
      try {
        const response = await fetch(`${API_URL}?action=searchStudentByName&name=${encodeURIComponent(name)}`);
        const result = await response.json();

        if (result.ok && result.results?.length > 0) {
          container.innerHTML = "";
          result.results.forEach(s => {
            const card = document.createElement("div");
            card.className = "selectable-card";
            card.dataset.sid = s.studentId;
            card.innerHTML = `
              <div class="card-line">
                <span class="card-title">${s.studentName}</span>
                ${genderIcon(s.gender)}
              </div>`;
            card.addEventListener("click", () => onSelectStudentCard(card));
            container.appendChild(card);
          });
          showNotification("‚úÖ Students loaded successfully", "success", "notificationSearch");
        } else {
          container.innerHTML = `<p style="color:red">No student found</p>`;
          showNotification("‚ùå No matching student", "error", "notificationSearch");
        }
      } catch (err) {
        showNotification("‚ö†Ô∏è Network error: " + err.message, "error", "notificationSearch");
      } finally {
        btn.disabled = false; btn.innerText = "Search";
      }
    }

    // ÈÄâ‰∏≠Â≠¶Áîü
    function onSelectStudentCard(card) {
      
      // 1Ô∏è‚É£ ÂèñÊ∂àÊâÄÊúâÂ≠¶ÁîüÈ´ò‰∫Æ
      document.querySelectorAll("#searchResult .selectable-card").forEach(c => c.classList.remove("selected"));
      card.classList.add("selected");
      selectedStudentId = card.dataset.sid;
      
      // 2Ô∏è‚É£ Ê∏ÖÁ©∫ËØæÁ®ãÈÄâÊã©Êï∞ÊçÆ
      for (let k in selectedCourses) delete selectedCourses[k];
      
      // 3Ô∏è‚É£ ÁßªÈô§ËØæÁ®ãÂç°ÁâáÈ´ò‰∫Æ
      document.querySelectorAll("#courseAccordion .selectable-card").forEach(c => c.classList.remove("selected"));
      
      // 4Ô∏è‚É£ ÈáçÁΩÆÊØè‰∏™ dayOfWeek ÁöÑËÆ°Êï∞
      document.querySelectorAll(".day-count").forEach(span => {
        const totalMatch = span.textContent.match(/\/\\s*(\\d+)\\s*classes/);
        const total = totalMatch ? totalMatch[1] : "0";
        span.textContent = `0 selected / ${total} classes`;
      });
      
      // 5Ô∏è‚É£ Êõ¥Êñ∞Êèê‰∫§ÊåâÈíÆÁä∂ÊÄÅ
      updateSubmitState();
      showNotification("üéØ Student re-selected. Course selections cleared.", "info", "notificationApply"); 
    }

    // Âä†ËΩΩËØæÁ®ãÔºàAccordionÔºâ
    document.addEventListener("DOMContentLoaded", loadCourses);

    async function loadCourses() {
      const acc = document.getElementById("courseAccordion");
      acc.innerHTML = "<p>Loading courses...</p>";

      try {
        const name = "";
        const res = await fetch(`${API_URL}?action=searchCourseByName&name=${encodeURIComponent(name)}`);
        // const res = await fetch(`${API_URL}?action=getActiveClasses`);        
        // const body = new URLSearchParams({ action: "listActiveCourses" });
        // const res = await fetch(API_URL, { method:"POST", headers:{"Content-Type":"application/x-www-form-urlencoded"}, body });
        const data = await res.json();

        if (!data.ok || !data.results?.length) {
          acc.innerHTML = "<p style='color:red'>No active courses found</p>";
          return;
        }

        acc.innerHTML = "";

        // Filter inactive classes
        const activeCourses = data.results.filter(c=> {
          const s = (c.status || "").toString().toLowerCase().trim();
          return s !== "inactive" && s != "disabled";
        });
        
        const order = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
        const map = {};
        activeCourses.forEach(c => {
          const day = c.dayOfWeek || "Unassigned";
          if (!map[day]) map[day] = [];
          map[day].push(c);
        });

        order.forEach(day => {
          const list = map[day];
          if (!list) return;

          const section = document.createElement("div");
          section.className = "accordion-section";

          const header = document.createElement("div");
          header.className = "accordion-header";
          header.innerHTML = `
            <span class="day-title">${day}</span>
            <span class="day-count" data-day="${day}">0 selected / ${list.length} classes</span>`;
          
          const content = document.createElement("div");
          content.className = "accordion-content";

          list.forEach(c => {
            const card = document.createElement("div");
            card.className = "selectable-card";
            card.dataset.cid = c.className;
            card.dataset.day = day;
            card.innerHTML = `
              <div class="card-line">
                <span class="card-title">${c.className}</span>
                <span class="card-sub">${c.dateFrom} - ${c.dateTo}</span>
              </div>              
            `;
            card.addEventListener("click", () => onSelectCourseCard(day, card));
            content.appendChild(card);
          });

          header.addEventListener("click", () => content.classList.toggle("open"));
          section.appendChild(header);
          section.appendChild(content);
          acc.appendChild(section);
        });

        showNotification("‚úÖ Courses loaded successfully", "success", "notificationApply");
      } catch (err) {
        acc.innerHTML = "<p style='color:red'>Failed to load courses</p>";
        showNotification("‚ö†Ô∏è Failed to load courses: " + err.message, "error", "notificationApply");
      }
    }

    // ÈÄâ‰∏≠ËØæÁ®ã + Êõ¥Êñ∞ header Áä∂ÊÄÅ
    function onSelectCourseCard(day, card) {
      const allCards = document.querySelectorAll(`.selectable-card[data-day='${day}']`);
      allCards.forEach(c => c.classList.remove("selected"));
      if (selectedCourses[day] === card.dataset.cid) {
        delete selectedCourses[day];
      } else {
        selectedCourses[day] = card.dataset.cid;
        card.classList.add("selected");
      }
      updateDayHeaderCount(day);
      updateSubmitState();
    }

    // Êõ¥Êñ∞ÊØè‰∏™ day ÁöÑÈÄâ‰∏≠ËÆ°Êï∞
    function updateDayHeaderCount(day) {
      const headerCount = document.querySelector(`.day-count[data-day='${day}']`);
      const total = document.querySelectorAll(`.selectable-card[data-day='${day}']`).length;
      const selected = selectedCourses[day] ? 1 : 0;
      if (headerCount) headerCount.textContent = `${selected} selected / ${total} classes`;
    }

    function updateSubmitState() {
      const btn = document.getElementById("ApplySubmit");
      console.log("üü¢ updateSubmitState called:", { selectedStudentId, selectedCourses });

      if (!btn) {
        console.warn(" CAN NOT FIND APPLYSUBMIT BUTTON");
      }

      const canSubmit = !!(selectedStudent && Object.keys(selectedCourses).length > 0);
      console.log(" canSubmit = ", canSubmit);

      btn.disabled = !canSubmit;      
      console.log("Button state:", btn.disabled ? "Disabled" : "Enabled");
      // btn.disabled = !(selectedStudentId && Object.keys(selectedCourses).length > 0);
    }

    // Êèê‰∫§Êä•Âêç
    async function submitApplication() {
      if (!selectedStudentId || Object.keys(selectedCourses).length === 0) return;
      const btn = document.getElementById("ApplySubmit");
      btn.disabled = true; btn.innerText = "Submitting...";

      try {
        for (const [day, classId] of Object.entries(selectedCourses)) {          
          const body = 
          "action=" + encodeURIComponent("applyStudentToClass") +
          "&studentId=" + encodeURIComponent(studentId) +
          "&className=" + encodeURIComponent(classId); 

          alert("BODY: " + body);
          
          await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
            body: body
          });
        }
        showNotification("‚úÖ Application submitted successfully!", "success", "notificationApply");
        document.getElementById("searchResult").innerHTML = "";
        document.querySelectorAll(".selectable-card").forEach(c => c.classList.remove("selected"));
        for (let k in selectedCourses) delete selectedCourses[k];
        document.querySelectorAll(".day-count").forEach(span => {
          const total = span.textContent.match(/\\d+ classes/)[0];
          span.textContent = `0 selected / ${total}`;
        });
        selectedStudentId = null;
        updateSubmitState();
      } catch (err) {
        showNotification("‚ùå Submission failed: " + err.message, "error", "notificationApply");
      } finally {
        btn.disabled = false; btn.innerText = "Submit Application";
      }
    }
  </script>
</body>
</html>
