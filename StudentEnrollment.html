<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Enrollment</title>
  <link rel="stylesheet" href="style.css">
  <script src="config.js"></script>
</head>
<body class="page-student">

  <!-- 左上角小 Logo -->
  <img src="icons/logo-monica-linan.svg" alt="Logo" class="logo-top-left">

  <!-- 主内容 -->
  <main class="page-content">

    <!-- 学生录入 -->
    <div class="form-container">
      <h2>Student Enrollment</h2>

      <!-- 1st row: Student name -->
      <label for="studentName">Student Name</label>
      <input type="text" id="studentName" placeholder="Enter student name">

      <!-- 2nd row: gender and DOB -->
      <div class="row">
        <div class="col">
          <label for="gender">Gender</label>
          <select id="gender">
            <option value="">Select</option>
            <option value="M">Male</option>
            <option value="F">Female</option>
          </select>
        </div>
        <div class="col">
          <label for="dob">Date of Birth</label>
          <input type="date" id="dob">
        </div>
      </div>

      <!-- 3rd row: Guardian name and contact number -->
      <div class="row">
        <div class="col">
          <label for="guardianName">Guardian Name</label>
          <input type="text" id="guardianName" placeholder="Enter guardian name">
        </div>
        <div class="col">
          <label for="guardianNumber">Guardian Number</label>
          <input type="tel" id="guardianNumber" placeholder="Enter guardian contact number">
        </div>
      </div>

      <!-- 4th row: Emergency name and contact number -->
      <div class="row">
        <div class="col">
          <label for="emergencyName">Emergency Name</label>
          <input type="text" id="emergencyName" placeholder="Enter emergency contact name">
        </div>
        <div class="col">
          <label for="emergencyNumber">Emergency Number</label>
          <input type="tel" id="emergencyNumber" placeholder="Enter emergency contact number">
        </div>
      </div>

      <button class="btn-primary" id="EnrollmentSubmit" onclick="submitStudent()">Submit</button>
    </div>

    <!-- 学生查询 -->
    <div class="form-container">
      <h2>Search Student</h2>

      <input type="text" id="searchName" placeholder="Enter student name">
      <button class="btn-primary" id="SearchBtn" onclick="searchStudent()">Search</button>

      <div id="searchResult" style="display:none; margin-top:12px;">
        <p><strong>Student ID:</strong> <span id="resId"></span></p>
        <p><strong>Name:</strong> <span id="resName"></span></p>
        <p><strong>Gender:</strong> <span id="resGender"></span></p>
        <p><strong>DOB:</strong> <span id="resDob"></span></p>
        <p><strong>Guardian:</strong> <span id="resGuardian"></span> (<span id="resGuardianContact"></span>)</p>
        <p><strong>Emergency:</strong> <span id="resEmergency"></span> (<span id="resEmergencyContact"></span>)</p>
      </div>
    </div>

  </main>

  <!-- 底部导航 -->
  <nav class="bottom-nav">
    <a class="nav-item nav-student active" href="StudentEnrollment.html" aria-label="Student Enrollment">
      <img src="icons/student-enroll.svg" alt="">
    </a>
    <a class="nav-item nav-course" href="CourseEnrollment.html" aria-label="Course Enrollment">
      <img src="icons/course-enroll.svg" alt="">
    </a>
    <a class="nav-item nav-student-course-application" href="StudentCourseApplication.html" aria-label="Student Course Application">
      <img src="icons/student-course-application.svg" alt="">
    </a>    
    <a class="nav-item nav-attend" href="Attendance.html" aria-label="Attendance">
      <img src="icons/attendance.svg" alt="">
    </a>
    <a class="nav-item nav-report" href="Report.html" aria-label="Reports">
      <img src="icons/report.svg" alt="">
    </a>
  </nav>

  <!-- JS 功能 -->
  <script>
    // 提交函数
    async function submitStudent() {

      const btn = document.getElementById("EnrollmentSubmit");
      btn.disabled = true;
      btn.innerText = "Submitting...";
      
      const student = {
        //action: "addStudent",  // *addStudent action
        studentName: document.getElementById("studentName").value,
        gender: document.getElementById("gender").value,
        dob: document.getElementById("dob").value,
        guardianName: document.getElementById("guardianName").value,
        guardianPhone: document.getElementById("guardianNumber").value,
        emergencyName: document.getElementById("emergencyName").value,
        emergencyPhone: document.getElementById("emergencyNumber").value,
      };

      if (!student.studentName) {
        alert("Please enter student name");
        btn.disabled = false;
        btn.innerText = "Submit";
        return;
      }

      if (!student.gender) {
        alert("Please enter gender");
        btn.disabled = false;
        btn.innerText = "Submit";
        return;
      }      

      if (!student.dob) {
        alert("Please select date of birth")
        btn.disabled = false;
        btn.innerText = "Submit";
        return;
      }
      
      if (!student.name || !student.gender || !student.dob) {
        alert("Please fill in name, gender and date of birth");
        btn.disabled = false;
        btn.innerText = "Submit";
        return;
      }
      
      try {
        const response = await fetch(`${API_URL}?action=addStudent`, {
          method: "POST",
          //header: {"Content-Type": "application/json"},
          header: {"Content-Type":"text/plain"},
          body: JSON.stringify({student})
        });

        const result = await response.json();
        if (result.status === "success") {
          alert(`Student submitted successfully! ID: ${result.studentId}`);
        } else {
          alert("Error: " + (result.message || "Unknown error"));
        }
      } catch (err) {
        alert("Network error: " + err.message);
      } finally {
        // restore button "submit" 
        btn.disabled = false;
        btn.innerText = "Submit";
      }
    }

    // 查询函数
    async function searchStudent() {
      const btn = document.getElementById("searchBtn");
      btn.disabled=true;
      btn.innerText = "Searching...";
      
      const name = document.getElementById("searchName").value.trim();
      if (!name) {
        alert("Please enter a student name");
        btn.disabled = false;
        btn.innerText = "Search";
        return;
      }

      try {
        const response = await fetch(`${API_URL}action=searchStudent`);
        const result = await response.json();

        if (result && result.studentId) {
          document.getElementById("searchResult").style.display = "block";
          document.getElementById("resId").innerText = result.studentId || "";
          document.getElementById("resName").innerText = result.name || "";
          document.getElementById("resGender").innerText = result.gender || "";
          document.getElementById("resDob").innerText = result.dob || "";
          document.getElementById("resGuardian").innerText = result.guardianName || "";
          document.getElementById("resGuardianContact").innerText = result.guardianContact || "";
          document.getElementById("resEmergency").innerText = result.emergencyName || "";
          document.getElementById("resEmergencyContact").innerText = result.emergencyContact || "";
        } else {
          document.getElementById("searchResult").style.display = "block";
          document.getElementById("searchResult").innerHTML = "<p style='color:red;'>No student found</p>";
        }
      } catch (err) {
        alert("Network error: " + err.message);
      } finally {
        btn.disabled = false;
        btn.innerText = "Search";
      }
    }    
  </script>
</body>
</html>
