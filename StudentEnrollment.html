<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Enrollment</title>
  <link rel="stylesheet" href="style.css">
  <script src="config.js"></script>
</head>
<body class="page-student">

  <!-- 左上角小 Logo -->
  <img src="icons/logo-monica-linan.svg" alt="Logo" class="logo-top-left">

  <!-- 主内容 -->
  <main class="page-content">

    <!-- 学生录入 -->
    <div class="form-container">
      <h2>Student Enrollment</h2>

      <!-- 1st row: Student name -->
      <label for="studentName">Student Name</label>
      <input type="text" id="studentName" placeholder="Enter student name">

      <!-- 2nd row: gender and DOB -->
      <div class="row">
        <div class="col">
          <label for="gender">Gender</label>
          <select id="gender">
            <option value="">Select</option>
            <option value="M">Male</option>
            <option value="F">Female</option>
          </select>
        </div>
        <div class="col">
          <label for="dob">Date of Birth</label>
          <input type="date" id="dob">
        </div>
      </div>

      <!-- 3rd row: Guardian name and contact number -->
      <div class="row">
        <div class="col">
          <label for="guardianName">Guardian Name</label>
          <input type="text" id="guardianName" placeholder="Enter guardian name">
        </div>
        <div class="col">
          <label for="guardianNumber">Guardian Number</label>
          <input type="tel" id="guardianNumber" placeholder="Enter guardian contact number">
        </div>
      </div>

      <!-- 4th row: Emergency name and contact number -->
      <div class="row">
        <div class="col">
          <label for="emergencyName">Emergency Name</label>
          <input type="text" id="emergencyName" placeholder="Enter emergency contact name">
        </div>
        <div class="col">
          <label for="emergencyNumber">Emergency Number</label>
          <input type="tel" id="emergencyNumber" placeholder="Enter emergency contact number">
        </div>
      </div>

      <button class="btn-primary" id="EnrollmentSubmit" onclick="submitStudent()">Submit</button>
    </div>

    <!-- 学生查询 -->
    <div class="form-container">
      <h2>Search Student</h2>

      <!-- Input box and button -->
      <div class="row">
        <div class="col">
          <input type="text" id="searchName" placeholder="Enter student's name">
        </div>
        <div>
          <button class="btn-primary" id="SearchBtn" onclick="searchStudent()">Search</button>
        </div>
      </div>

      <!-- Search results -->
      <div id="searchResult" style="margin-top:12px;"></div>
    </div>

  </main>

  <!-- 底部导航 -->
  <nav class="bottom-nav">
    <a class="nav-item nav-student active" href="StudentEnrollment.html" aria-label="Student Enrollment">
      <img src="icons/student-enroll.svg" alt="">
    </a>
    <a class="nav-item nav-course" href="CourseEnrollment.html" aria-label="Course Enrollment">
      <img src="icons/course-enroll.svg" alt="">
    </a>
    <a class="nav-item nav-student-course-application" href="StudentCourseApplication.html" aria-label="Student Course Application">
      <img src="icons/student-course-application.svg" alt="">
    </a>    
    <a class="nav-item nav-attend" href="Attendance.html" aria-label="Attendance">
      <img src="icons/attendance.svg" alt="">
    </a>
    <a class="nav-item nav-report" href="Report.html" aria-label="Reports">
      <img src="icons/report.svg" alt="">
    </a>
  </nav>

  <!-- JS 功能 -->
  <script>
    // 提交函数
    async function submitStudent() {

      const btn = document.getElementById("EnrollmentSubmit");
      btn.disabled = true;
      btn.innerText = "Submitting...";
      
      const student = {
        //action: "addStudent",  // *addStudent action
        studentName: document.getElementById("studentName").value,
        gender: document.getElementById("gender").value,
        dob: document.getElementById("dob").value,
        guardianName: document.getElementById("guardianName").value,
        guardianPhone: document.getElementById("guardianNumber").value,
        emergencyName: document.getElementById("emergencyName").value,
        emergencyPhone: document.getElementById("emergencyNumber").value,
      };

      if (!student.studentName || !student.gender || !student.dob) {
        alert("Please fill in name, gender and date of birth");
        btn.disabled = false;
        btn.innerText = "Submit";
        return;
      }
      
      try {
        const response = await fetch(`${API_URL}?action=addStudent`, {
          method: "POST",
          //header: {"Content-Type": "application/json"},
          header: {"Content-Type":"text/plain"},
          body: JSON.stringify(student)
        });

        const result = await response.json();
        if (result.ok) {
          alert(`Student submitted successfully! ID: ${result.studentId}`);
        } else {
          alert("Error: " + (result.message || "Unknown error"));
        }
      } catch (err) {
        alert("Network error: " + err.message);
      } finally {
        // restore button "submit" 
        btn.disabled = false;
        btn.innerText = "Submit";
      }
    }

    // 查询函数
    async function searchStudent() {
      const btn = document.getElementById("SearchBtn");

      if (!btn) {
        console.error("SearchBtn not found in DOM");
        return;
      }
      
      btn.disabled=true;
      const originalText = btn.innerText;
      btn.innerText = "Searching...";
      
      const name = document.getElementById("searchName").value.trim();
      const container = document.getElementById("searchResult");
      
      if (!name) {
        alert("Please enter a student name");
        btn.disabled = false;
        btn.innerText = originalText;
        return;
      }

      try {
        const response = await fetch(`${API_URL}?action=searchStudentByName&name=${encodeURIComponent(name)}`);
        const result = await response.json();

        if (result.ok && result.results && result.results.length > 0) {
          results.results.forEach((s,idx) => {

            console.log("Student: ", s.studentId, s.studentName, s.dob);
            
            const card = document.createElement("div");
            card.className = "student-card";

            // header: ID + Name
            const header = document.createElement("div");
            header.className = "student-header";
            header.innerHTML = `
              <div>Student ID: ${s.studentId}</div>
              <div>${s.studentName}</div>
            `;

            // Details: hiding in default
            const details = document.createElement("div");
            details.className = "student-details";
            details.innerHTML = `
              <div class="row">
                <div class="col"><strong>Gender: </strong> ${s.gender}</div>
                <div class="col"><strong>DOB: </strong> ${s.dob}</div>
              </div>
              <div class="row">
                <div class="col">
                  <strong>Guardian:</strong> ${s.guardianName} / ${s.guardianPhone}
                  <span class="contact-actions">
                    <button onclick="callNumber('${s.guardianPhone}')">📞</button>
                    <button onclick="smsNumber('${s.guardianPhone}')">💬</button>
                  </span>
                </div>
              </div>
              <div class="row">
                <div class="col">
                  <strong>Emergency:</strong> ${s.emergencyName} / ${s.emergencyPhone}
                  <span class="contact-actions">
                    <button onclick="callNumber('${s.emergencyPhone}')">📞</button>
                    <button onclick="smsNumber('${s.emergencyPhone}')">💬</button>
                  </span>
                </div>
              </div>
            `;

            // Click to expland
            header.addEventListener("click", () => {
              const expanded = details.style.display === "block";
              // Collapse other cards
              document.querySelectorAll(".student-details").forEach(d => d.style.display = "none");
              document.querySelectorAll(".student-header").forEach(h => h.classList.remove("selected"));

              // Expand the current one
              if (!expanded) {
                details.style.display = "block";
                header.classList.add("selected");
              }
            });

            card.appendChild(header);
            card.appendChild(details);
            container.appendChild(card);
          });
        } else {
          container.innerHTML = `<p style="color:red">${result.message || "No student found"}</p>`;
        }
      } catch (err) {
        alert("Network error: " + err.message);
      } finally {
        btn.disabled = false;
        btn.innerText = originalText;
      }
    }

    function callNumber(number) {
      if (number) {
        window.location.href = `tel:${number}`;
      }
    }

    function smsNumber(number) {
      if (number) {
        window.location.href = `sms:${number}`;
      }
    }
  </script>
</body>
</html>
