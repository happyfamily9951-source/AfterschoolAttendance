<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Student Enrollment</title>
  <link rel="stylesheet" href="style.css">
  <script src="config.js"></script>
</head>
<body class="page-student">

  <!-- å·¦ä¸Šè§’å° Logo -->
  <img src="icons/logo-monica-linan.svg" alt="Logo" class="logo-top-left">
  
  <!-- ä¸»å†…å®¹ -->
  <main class="page-content">

    <!-- å­¦ç”Ÿå½•å…¥ -->
    <div class="form-container">
      <h2>Student Enrollment</h2>
      
      <!-- Notification bar -->
      <div id="notification" class="notification hidden"></div>

      <!-- 1st row: Student name -->
      <label for="studentName">Student Name</label>
      <input type="text" id="studentName" placeholder="Enter student name">

      <!-- 2nd row: gender and DOB -->
      <div class="row">
        <div class="col">
          <label for="gender">Gender</label>
          <select id="gender">
            <option value="">Select</option>
            <option value="M">Male</option>
            <option value="F">Female</option>
          </select>
        </div>
        <div class="col">
          <label for="dob">Date of Birth</label>
          <input type="date" id="dob">
        </div>
      </div>

      <!-- 3rd row: Guardian name and contact number -->
      <div class="row">
        <div class="col">
          <label for="guardianName">Guardian Name</label>
          <input type="text" id="guardianName" placeholder="Enter guardian name">
        </div>
        <div class="col">
          <label for="guardianNumber">Guardian Number</label>
          <input type="tel" id="guardianNumber" placeholder="Enter guardian contact number">
        </div>
      </div>

      <!-- 4th row: Emergency name and contact number -->
      <div class="row">
        <div class="col">
          <label for="emergencyName">Emergency Name</label>
          <input type="text" id="emergencyName" placeholder="Enter emergency contact name">
        </div>
        <div class="col">
          <label for="emergencyNumber">Emergency Number</label>
          <input type="tel" id="emergencyNumber" placeholder="Enter emergency contact number">
        </div>
      </div>

      <button class="btn-primary" id="EnrollmentSubmit" onclick="addStudent()">Submit</button>
    </div>

    <!-- å­¦ç”ŸæŸ¥è¯¢ -->
    <div class="form-container">
      <h2>Search Student</h2>

      <!-- Input box and button -->
      <div class="row">
        <div class="col">
          <input type="text" id="searchName" placeholder="Enter student's name">
        </div>
        <div>
          <button class="btn-primary" id="SearchBtn" onclick="searchStudent()">Search</button>
        </div>
      </div>

      <!-- Search results -->
      <div id="searchResult" style="margin-top:12px;"></div>
    </div>

  </main>

  <!-- åº•éƒ¨å¯¼èˆª -->
  <nav class="bottom-nav">
    <a class="nav-item nav-student active" href="StudentEnrollment.html" aria-label="Student Enrollment">
      <img src="icons/student-enroll.svg" alt="">
    </a>
    <a class="nav-item nav-course" href="CourseEnrollment.html" aria-label="Course Enrollment">
      <img src="icons/course-enroll.svg" alt="">
    </a>
    <a class="nav-item nav-student-course-application" href="StudentCourseApplication.html" aria-label="Student Course Application">
      <img src="icons/student-course-application.svg" alt="">
    </a>    
    <a class="nav-item nav-attend" href="Attendance.html" aria-label="Attendance">
      <img src="icons/attendance.svg" alt="">
    </a>
    <a class="nav-item nav-report" href="Report.html" aria-label="Reports">
      <img src="icons/report.svg" alt="">
    </a>
  </nav>

  <!-- JS åŠŸèƒ½ -->
  <script>
    // æäº¤å‡½æ•°
    async function addStudent() {

      const btn = document.getElementById("EnrollmentSubmit");
      btn.disabled = true;
      const originalText = btn.innerText;
      btn.innerText = "Submitting...";

      // Version A: x-www-form-urlencoded
      // Step A1: retrieve the values
      const studentName = document.getElementById("studentName").value.trim();
      const gender = document.getElementById("gender").value.trim();
      const dob = document.getElementById("dob").value.trim();
      const guardianName = document.getElementById("guardianName").value.trim();
      const guardianPhone = document.getElementById("guardianNumber").value.trim();
      const emergencyName = document.getElementById("emergencyName").value.trim();
      const emergencyPhone = document.getElementById("emergencyNumber").value.trim();

      // Step A2: validate data
      // if (!studentName || !gender || !dob) {
      //  alert("Please fill in name, gender and date of birth");
      //  btn.disabled = false;
      //  btn.innerText = originalText;
      //  return;
      // }      

      if (!studentName) {
        alert("Please fill in student name");
        btn.disabled = false;
        btn.innerText = originalText;
        return;
      }

      // Step A3: Generate body
      const body =
        "action=" + encodeURIComponent("addStudent") +
        "&studentName=" + encodeURIComponent(studentName) +
        "&gender=" + encodeURIComponent(gender) +
        "&dob=" + encodeURIComponent(dob) +
        "&guardianName=" + encodeURIComponent(guardianName) +
        "&guardianPhone=" + encodeURIComponent(guardianPhone) +
        "&emergencyName=" + encodeURIComponent(emergencyName) +
        "&emergencyPhone=" + encodeURIComponent(emergencyPhone);


      // Version B: text/plain or application/JSON
      //const student = {
      //  //action: "addStudent",  // *addStudent action
      //  studentName: document.getElementById("studentName").value,
      //   gender: document.getElementById("gender").value,
      //  dob: document.getElementById("dob").value,
      //  guardianName: document.getElementById("guardianName").value,
      //  guardianPhone: document.getElementById("guardianNumber").value,
      //  emergencyName: document.getElementById("emergencyName").value,
      //  emergencyPhone: document.getElementById("emergencyNumber").value,
      //};

      // if (!student.studentName || !student.gender || !student.dob) {
      //  alert("Please fill in name, gender and date of birth");
      //  btn.disabled = false;
      //  btn.innerText = "Submit";
      //  return;
      //}
      
      try {

        // Version A: x-www-form-urlencoded
        // Step A4: 
        const response = await fetch(API_URL, {
          method: "POST",
          headers: {"Content-Type": "application/x-www-form-urlencoded;charset=UTF-8"},
          body: body
        });

        // Version B: text/plain
        // const response = await fetch(`${API_URL}?action=addStudent`, {
        //  method: "POST",
        //  //header: {"Content-Type": "application/json"},
        //  header: {"Content-Type":"text/plain"},
        //  body: JSON.stringify(student)
        //});

        const result = await response.json();
        if (result.ok) {
          showNotification("âœ… Student added successfully!", "success");
          alert("âœ… Student added successfully!";
        } else {
          showNotification("âŒ " + (result.message || "Unknown error"), "error");   
          alert("âŒ Student added failure!");
        }
      } catch (err) {
        alert("Network error: " + err.message);
      } finally {
        // restore button "submit" 
        btn.disabled = false;
        btn.innerText = "Submit";
      }
    }

    // æŸ¥è¯¢å‡½æ•°
    async function searchStudent() {
      const btn = document.getElementById("SearchBtn");

      if (!btn) {
        console.error("SearchBtn not found in DOM");
        return;
      }
      
      btn.disabled=true;
      const originalText = btn.innerText;
      btn.innerText = "Searching...";
      
      const name = document.getElementById("searchName").value.trim();
      const container = document.getElementById("searchResult");
      
      if (!name) {
        alert("Please enter a student name");
        btn.disabled = false;
        btn.innerText = originalText;
        return;
      }

      try {
        const response = await fetch(`${API_URL}?action=searchStudentByName&name=${encodeURIComponent(name)}`);
        const result = await response.json();

        if (result.ok && result.results && result.results.length > 0) {
          result.results.forEach(s => {

            console.log("Student: ", s.studentId, s.studentName, s.dob); 
            
            const dob = formatDate(s.dob || "");
            const card = document.createElement("div");
            card.className = "student-card";

            // header: ID + Name
            const header = document.createElement("div");
            header.className = "student-header";
            header.innerHTML = `
              <div><strong>Student ID: </strong>${s.studentId || ""}</div>
              <div>${s.studentName || ""}</div>
            `;

            // Details: hiding in default
            const details = document.createElement("div");
            details.className = "student-details";
            details.style.display = "none";
            details.innerHTML = `
              <div class="row">
                <div class="col"><strong>Gender: </strong> ${s.gender || ""}</div>
                <div class="col"><strong>DOB: </strong> ${dob}</div>
              </div>
              <div class="row">
                <div class="col">
                  <strong>Guardian:</strong> ${s.guardianName} / ${s.guardianPhone}
                  <span class="contact-actions">
                    <button onclick="callNumber('${s.guardianPhone || ""}')">ðŸ“ž</button>
                    <button onclick="smsNumber('${s.guardianPhone || ""}')">ðŸ’¬</button>
                  </span>
                </div>
              </div>
              <div class="row">
                <div class="col">
                  <strong>Emergency:</strong> ${s.emergencyName || ""} / ${s.emergencyPhone || ""}
                  <span class="contact-actions">
                    <button onclick="callNumber('${s.emergencyPhone ||Â ""}')">ðŸ“ž</button>
                    <button onclick="smsNumber('${s.emergencyPhone || ""}')">ðŸ’¬</button>
                  </span>
                </div>
              </div>
            `;

            // Click to expland
            header.addEventListener("click", () => {
              const expanded = details.style.display === "block";
              // Collapse other cards
              document.querySelectorAll(".student-details").forEach(d => d.style.display = "none");
              document.querySelectorAll(".student-header").forEach(h => h.classList.remove("selected"));

              // Expand the current one
              if (!expanded) {
                details.style.display = "block";
                header.classList.add("selected");
              }
            });

            card.appendChild(header);
            card.appendChild(details);
            container.appendChild(card);
          });
        } else {
          container.innerHTML = `<p style="color:red">${result.message || "No student found"}</p>`;
        }
      } catch (err) {
        alert("Network error: " + err.message);
      } finally {
        btn.disabled = false;
        btn.innerText = originalText;
      }
    }
  </script>
</body>
</html>
