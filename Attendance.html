<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance</title>
    <link rel="stylesheet" href="style.css">
    <script src="config.js"></script>
    <style>
      .student-card {
        border: 1px solid #ddd;
        border-radius: 12px;
        padding: 12px;
        margin-bottom: 10px;
        background: #fff;
        box-shadow: 0 2px 6px rgba(0,0,0,.1);
      }
      
      .student-name { font-weight: bold; margin-bottom: 8px; }
      .attendance-buttons { display: flex; gap: 10px; }
      .btn-status {
        flex: 1;
        padding: 10px;
        border-radius: 20px;
        border: none;
        font-weight: bold;
        cursor: pointer;
        color: #fff;
        background: #ccc;
      }
      
      .btn-status.active.present { background: #28a745; }
      .btn-status.active.absent { background: #dc3545; }
      .btn-status.active.leave { background: #ffc107; color:#333; }
      .leave-note { margin-top: 6px; font-size: 0.9em; color: #555; }
      #attendanceSummary { margin: 8px 0; font-weight: bold; color: #1A73E8; }
      .highlight { background: #ffecb3; }
    </style>
  </head>
  
  <body class="page-attendance">
    <img src="icons/logo-monica-linan.svg" alt="Logo" class="logo-top-left">
    <main class="page-content">
      <h2>Class Attendance</h2>
      
      <div class="form-container">
        <h2>Select Class</h2>
        <select id="classSelect"></select>
      </div>
      
      <div class="form-container" id="attendanceContainer" style="display:none;">
        <h2>Mark Attendance</h2>
        <div id="attendanceSummary">Total: 0 | 游릭 P: 0 | 游댮 A: 0 | 游리 L: 0</div>
        <div id="studentList"></div>
        <button class="btn-primary" id="AttendanceSubmit" onclick="submitAttendance()">Submit</button>
      </div>
    </main>
    
    <!-- Nagivator button on the bottom -->
    <nav class="bottom-nav">
      <a class="nav-item nav-student active" href="StudentEnrollment.html" aria-label="Student Enrollment">
        <img src="icons/student-enroll.svg" alt="">
      </a>
      <a class="nav-item nav-course" href="CourseEnrollment.html" aria-label="Course Enrollment">
        <img src="icons/course-enroll.svg" alt="">
      </a>
      <a class="nav-item nav-student-course-application" href="StudentCourseApplication.html" aria-label="Student Course Application">
        <img src="icons/student-course-application.svg" alt="">
      </a>    
      <a class="nav-item nav-attend" href="Attendance.html" aria-label="Attendance">
        <img src="icons/attendance.svg" alt="">
      </a>
      <a class="nav-item nav-report" href="Report.html" aria-label="Reports">
        <img src="icons/report.svg" alt="">
      </a>
    </nav>
    
    <script>
      let attendanceSummary = { total: 0, present: 0, absent: 0, leave: 0 };
      let currentClassId = null;
      
      async function loadClasses() {
        try {
          const response = await fetch(`${API_URL}?action=getActiveClasses`);
          const result = await response.json();
          const select = document.getElementById("classSelect");
          select.innerHTML = "<option value=''>Please select class</option>";
          
          result.results.forEach(c => {
            const option = document.createElement("option");
            option.value = c.classId;
            option.textContent = c.className + (c.highlight ? " 游릭" : "");
            select.appendChild(option);
          });
        } catch (err) {
          alert("Loading class failure: " + err.message);
        }
      }
      
      document.getElementById("classSelect").addEventListener("change", async (e) => {
        currentClassId = e.target.value;
        if (!currentClassId) return;
        try {
          const response = await fetch(`${API_URL}?action=getStudentsByClass&classId=${currentClassId}`);
          const result = await response.json();
          if (result.ok) {
            renderStudents(result.results);
            document.getElementById("attendanceContainer").style.display = "block";
          }
        } catch (err) {
          alert("Loading students failure: " + err.message);
        }
      });
      
      function renderStudents(students) {
        const container = document.getElementById("studentList");
        container.innerHTML = "";
        attendanceSummary = { total: students.length, present: 0, absent: 0, leave: 0 };
        
        students.forEach(s => {
          const card = document.createElement("div");
          card.className = "student-card";
          card.dataset.studentId = s.studentId;
          
          const leaveNote = s.leave ? `(${s.leaveType} - ${s.leaveNotes})` : "";
          const genderIcon = s.gender === "M" ? "游녽" : (s.gender === "F" ? "游녾" : "");
          
          card.innerHTML = `
          <div class="student-name">${s.studentName} ${genderIcon}</div>
          <div class="attendance-buttons">
          <button class="btn-status present" data-status="Present">Present</button>
          <button class="btn-status absent" data-status="Absent">Absent</button>
          <button class="btn-status leave" data-status="Leave">Leave</button>
          </div>
          
          <div class="leave-note" style="${s.leave ? "" : "display:none;"}">${leaveNote}</div>
          `;
          
          container.appendChild(card);
          
          // Default value: Leave if student already submit leave request, Present otherwise
          if (s.leave) {
            setStatus(card, "Leave");
          } else {
            setStatus(card, "Present");
          }
          
          card.querySelectorAll(".btn-status").forEach(btn => {
            btn.addEventListener("click", () => setStatus(card, btn.dataset.status));
          });
        });
        
        updateSummary();
      }
      
      function setStatus(card, status) {
        const buttons = card.querySelectorAll(".btn-status");
        buttons.forEach(b => b.classList.remove("active"));
        const targetBtn = card.querySelector(`.btn-status.${status.toLowerCase()}`);
        if (targetBtn) targetBtn.classList.add("active");
        updateSummary();
      }
      
      function updateSummary() {
        const allCards = document.querySelectorAll(".student-card");
        attendanceSummary.present = 0;
        attendanceSummary.absent = 0;
        attendanceSummary.leave = 0;
        
        allCards.forEach(card => {
          const activeBtn = card.querySelector(".btn-status.active");
          if (activeBtn) {
            attendanceSummary[activeBtn.dataset.status.toLowerCase()]++;
          }
        });
        
        document.getElementById("attendanceSummary").innerText =
          `Total: ${attendanceSummary.total} | 游릭 P: ${attendanceSummary.present} | 游댮 A: ${attendanceSummary.absent} | 游리 L: ${attendanceSummary.leave}`;
      }
      
      async function submitAttendance() {
        const btn = document.getElementById("AttendanceSubmit");
        btn.disabled = true;
        const originalText = btn.innerText;
        btn.innerText = "Submitting...";
        
        const records = [];
        document.querySelectorAll(".student-card").forEach(card => {
          const studentId = card.dataset.studentId;
          const activeBtn = card.querySelector(".btn-status.active");
          if (activeBtn) {
            records.push({ studentId, status: activeBtn.dataset.status });
          }
        });
        
        try {
          const response = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              action: "markAttendance",
              classId: currentClassId,
              records
            })
          });
          
          const result = await response.json();
          if (result.ok) {
            alert("Attendance submitted successfully!");
          } else {
            alert("Error: " + (result.message || "Unknown error"));
          }
        } catch (err) {
          alert("Network error: " + err.message);
        } finally {
          btn.disabled = false;
          btn.innerText = originalText;
        }
      }
      
      window.onload = loadClasses;
    </script>
  </body>
</html>
