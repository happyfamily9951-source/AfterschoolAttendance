<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance</title>
    <link rel="stylesheet" href="style.css">
    <script src="config.js"></script>    
  </head>
  
  <body class="page-attendance">
    <img src="icons/logo-monica-linan.svg" alt="Logo" class="logo-top-left">
    <!-- Notification bar -->
    <div id="notification" class="notification hidden"></div>
    
    <main class="page-content">

      <!-- Select class -->
      <div class="form-container">
        <h2>Select Class</h2>
        <select id="classSelect"></select>
        <button class="btn-primary" onclick="getStudents()">Get Student List</button>
      </div>

      <!-- Student attendance -->
      <div class="form-container" id="attendanceContainer" style="display:none;">
        <h2>Mark Attendance</h2>
        <div id="currentClassName" style="font-weight: bold;margin-bottom: 8px; color: #333;"></div>
        <div id="attendanceSummary">Total: 0 | üü¢ P: 0 | üî¥ A: 0 | üü° L: 0</div>
        <div id="studentList"></div>
        <button class="btn-primary" id="AttendanceSubmit" onclick="submitAttendance()">Submit</button>
      </div>
    </main>
    
    <!-- Nagivator button on the bottom -->
    <nav class="bottom-nav">
      <a class="nav-item nav-student active" href="StudentEnrollment.html" aria-label="Student Enrollment">
        <img src="icons/student-enroll.svg" alt="">
      </a>
      <a class="nav-item nav-course" href="CourseEnrollment.html" aria-label="Course Enrollment">
        <img src="icons/course-enroll.svg" alt="">
      </a>
      <a class="nav-item nav-student-course-application" href="StudentCourseApplication.html" aria-label="Student Course Application">
        <img src="icons/student-course-application.svg" alt="">
      </a>    
      <a class="nav-item nav-attend" href="Attendance.html" aria-label="Attendance">
        <img src="icons/attendance.svg" alt="">
      </a>
      <a class="nav-item nav-report" href="Report.html" aria-label="Reports">
        <img src="icons/report.svg" alt="">
      </a>
    </nav>
    
    <script>
      let attendanceSummary = { total: 0, present: 0, absent: 0, leave: 0 };
      let currentClassId = null;

      // 1. Load classes list      
      async function loadClasses() {
        try {
          const response = await fetch(`${API_URL}?action=getActiveClasses`);
          const result = await response.json();
          const select = document.getElementById("classSelect");
          select.innerHTML = "<option value=''>Please select class</option>";
          
          result.results.forEach(c => {
            const option = document.createElement("option");
            option.value = c.className;
            option.textContent = `${c.className} (${c.dayOfWeek})${c.highlight?" üü¢ Today" : ""}`;
            if (c.highlight) option.classList.add("today"); // highlight
            select.appendChild(option);
          });
        } catch (err) {
          alert("Loading class failure: " + err.message);
        }
      }

      // 2. Choose a class and get student list
      async function getStudents() {
        currentClassName = document.getElementById("classSelect").value;
        if (!currentClassName) return;

        const todayName = new Date().toLocaleString("en-us", {weekday: "short"});  // weekday: "long" ==> Monday
        const selectedOption = document.querySelector(`#classSelect option[value="${currentClassName}"]`);

        // Extract dayOfWeek from selectedOption
        const optionText = selectedOption ? selectedOption.textContent : "";
        const match = optionText.match(/\((.*?)\)/);
        const dayOfWeek = match ? match[1] : "";
        
        if (selectedOption && !selectedOption.textContent.includes(todayName)) {
          if (!confirm("The selected class is not today. Continue?")) return;
        }

        try {
          const response = await fetch(`${API_URL}?action=getStudentsByClass&className=${encodeURIComponent(currentClassName)}`);
          const result = await response.json();

          if (result.ok) {
            // Update class name
            document.getElementById("currentClassName").innerText = `${currentClassName} (${dayOfWeek})`;
            renderStudents(result.results);
            document.getElementById("attendanceContainer").style.display="block";
          }
        } catch (err) {
          alert("Load student list failure: " + err.message);
        }
      }

      // render student cards
      function renderStudents(students) {
        const container = document.getElementById("studentList");
        container.innerHTML = "";
        attendanceSummary = {total: students.length, present: 0, absent: 0, leave: 0};

        students.forEach( s=> {
          const card = document.createElement("div");
          card.className = "attendance-card";
          card.dataset.studentId = s.studentId;
          card.dataset.studentName = s.studentName;
          card.dataset.gender = s.gender;

          const genderIcon = s.gender === "M"
            ? '<img src="icons/male.svg" alt="M" class="attendance-gender-icon">'
            : (s.gender === "F"
               ? '<img src="icons/female.svg" alt="F" class="attendance-gender-icon">'
               : "");

          const leaveNote = s.leaveStatus === "Leave" ? `(${s.notes})` : "";

          card.innerHTML = `
            <div class="attendance-name">${s.studentName} ${genderIcon}</div>
            <div class="attendance-button">
              <button class="attendance-btn present" data-status="Present">Present</button>
              <button class="attendance-btn absent" data-status="Absent">Absent</button>
              <button class="attendance-btn leave" data-status="Leave">Leave</button>
            </div>
            <div class="attendance-note" style="${s.leaveStatus === "Leave" ? "" : "display:none;"}">${leaveNote}</div>
          `;

          container.appendChild(card);

          // Default value
          if (s.leaveStatus === "Leave") setStatus(card, "Leave");
          else setStatus(card, "Present");

          // Click
          card.querySelectorAll(".attendance-btn").forEach( btn => {
            btn.addEventListener("click", () => setStatus(card, btn.dataset.status));
          });
        });
        
        updateSummary();
      }

      // Set status
      function setStatus(card, status) {
        const buttons = card.querySelectorAll(".attendance-btn");
        buttons.forEach( b=> b.classList.remove("active"));
        const targetBtn = card.querySelector(`.attendance-btn.${status.toLowerCase()}`);        
        if (targetBtn) targetBtn.classList.add("active");
        updateSummary();
      }

      // Update summary
      function updateSummary() {
        const allCards = document.querySelectorAll(".attendance-card");
        attendanceSummary.present = 0;
        attendanceSummary.absent = 0;
        attendanceSummary.leave = 0;

        allCards.forEach(card => {
          const activeBtn = card.querySelector(".attendance-btn.active");

          if (activeBtn) {
            const status = activeBtn.dataset.status.toLowerCase();
            if (status === "present") attendanceSummary.present++;
            if (status === "absent") attendanceSummary.absent++;
            if (status === "leave") attendanceSummary.leave++;
          }
        });

        document.getElementById("attendanceSummary").innerText =
          `Total: ${attendanceSummary.total} | üü¢ P: ${attendanceSummary.present} | üî¥ A: ${attendanceSummary.absent} | üü° L: ${attendanceSummary.leave}`;
      }

      // Submit attendace
      async function submitAttendance() {
        const btn = document.getElementById("AttendanceSubmit");
        btn.disabled = true;
        const originalText = btn.innerText;
        btn.innerText = "Submitting...";

        const records = [];
        document.querySelectorAll(".attendance-card").forEach(card => {
          const studentId = card.dataset.studentId;
          const studentName = card.dataset.studentName;
          const gender = card.dataset.gender;
          const activeBtn = card.querySelector(".attendance-btn.active");
          const status = activeBtn ? activeBtn.dataset.status : "Absent";   // Default value is absent
          const notes = card.querySelector(".attendance-note")?.innerText || "";

          records.push({studentId, studentName, gender, status, notes});
        });

        // Version A: Convert to x-www-form-urlencoded format
        const body = 
          "action=" + encodeURIComponent("markAttendance") +
          "&className=" + encodeURIComponent(currentClassName) +
          "&records=" + encodeURIComponent(JSON.stringify(records)); 

        // Version B: JSON
        // const payload = {
        // action: "markAttendance",
        // className: currentClassName,
        // records: records
        // };

        try {          

          // Version A: x-www-form-urlencoded format
          const response = await fetch(API_URL, {
            method: "POST",
            headers: {"Content-Type": "application/x-www-form-urlencoded;charset=UTF-8"},            
            body: body
          });

          // Version B: JSON
          // const response = await fetch(API_URL, {
          //  method: "POST",
          //  headers: {"Content-Type": "application/json"},
          //  body: JSON.stringify(payload)
          //});

          const result = await response.json();
          if (result.ok) {
            showNotification(`‚úÖ Attendance submitted! (${result.count} records)`, "success");                        
          } else {
            showNotification(`‚ùå Error: ${result.message || "Unknown error"}`, "error");            
          }
        } catch (err) {
          showNotification("‚ùå Network error: " + err.message, "error");          
        } finally {
          btn.disabled = false;
          btn.innerText = originalText;
        }
      }
      window.onload = loadClasses;
    </script>
  </body>
</html>
